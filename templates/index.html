<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assaultron Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .resize-handle {
            background: #e5e5e5;
            cursor: ew-resize;
            width: 4px;
            min-height: 100%;
        }

        .resize-handle:hover {
            background: #999;
        }

        .panel {
            min-width: 300px;
        }

        /* Premium Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
            border: 2px solid #f1f1f1;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* For Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f1f1f1;
        }

        /* Immersion Mode Styles */
        .immersion-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .immersion-overlay.hidden {
            display: none;
        }

        .immersion-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10001;
        }

        .immersion-close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .immersion-visualizer-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 1200px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sound-visualizer {
            width: 100%;
            height: 100%;
        }

        .immersion-chat-history {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 1000px;
            max-height: 20vh;
            overflow-y: auto;
            padding: 20px;
            color: white;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.6;
            mask-image: linear-gradient(to bottom, transparent 0%, black 20%, black 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 20%, black 100%);
        }

        .immersion-chat-history::-webkit-scrollbar {
            width: 6px;
        }

        .immersion-chat-history::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .immersion-chat-history::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .immersion-input-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 1000px;
            display: flex;
            gap: 10px;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .immersion-chat-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }

        .immersion-chat-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .immersion-chat-input:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(59, 130, 246, 0.5);
        }

        .immersion-send-btn {
            background: rgba(59, 130, 246, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            border: none;
            font-weight: bold;
            font-family: monospace;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .immersion-send-btn:hover {
            background: rgba(59, 130, 246, 1);
            transform: scale(1.05);
        }

        .immersion-send-btn:disabled {
            background: rgba(100, 100, 100, 0.5);
            cursor: not-allowed;
            transform: scale(1);
        }

        .immersion-chat-message {
            margin-bottom: 8px;
            padding: 4px 0;
        }

        .immersion-chat-message.user {
            color: #60a5fa;
        }

        .immersion-chat-message.ai {
            color: #34d399;
        }
    </style>
</head>

<body class="bg-white text-gray-900 min-h-screen font-mono">
    <div class="h-screen flex flex-col">
        <!-- Tab Navigation -->
        <div class="bg-gray-100 border-b border-gray-300">
            <nav class="flex space-x-4 px-3">
                <button onclick="switchTab('interface')" id="tabInterface"
                    class="tab-button active py-2 px-4 text-sm font-bold border-b-2 border-blue-500">INTERFACE</button>
                <button onclick="switchTab('embodied')" id="tabEmbodied"
                    class="tab-button py-2 px-4 text-sm font-bold border-b-2 border-transparent hover:border-gray-400">EMBODIED
                    AGENT</button>
                <button onclick="switchTab('vision')" id="tabVision"
                    class="tab-button py-2 px-4 text-sm font-bold border-b-2 border-transparent hover:border-gray-400">VISION</button>
            </nav>
        </div>

        <!-- Interface Tab Content -->
        <div id="interfaceTab" class="flex-1 flex tab-content">
            <!-- Logs Panel -->
            <div id="logsPanel" class="panel bg-gray-50 border-r border-gray-300 flex flex-col" style="width: 50%;">
                <div class="p-3 bg-gray-100 border-b border-gray-300">
                    <h2 class="text-sm font-bold">System Logs</h2>
                </div>
                <div id="systemLogs" class="flex-1 p-3 overflow-y-auto text-xs space-y-1 bg-white">
                    <div class="text-blue-600">[INFO] Interface initialized</div>
                </div>
            </div>

            <!-- Resize Handle -->
            <div class="resize-handle" id="resizeHandle"></div>

            <!-- Chat Panel -->
            <div id="chatPanel" class="panel flex-1 flex flex-col">
                <div class="p-3 bg-gray-100 border-b border-gray-300 flex justify-between items-center">
                    <h2 class="text-sm font-bold">Chat</h2>
                    <div class="flex gap-2">
                        <button onclick="toggleImmersionMode()"
                            class="text-[10px] font-bold text-gray-600 hover:text-blue-500 transition-colors uppercase tracking-widest border border-gray-300 px-2 py-0.5 rounded bg-white">
                            Immersion Mode
                        </button>
                        <button onclick="reloadConversation()"
                            class="text-[10px] font-bold text-gray-600 hover:text-green-500 transition-colors uppercase tracking-widest border border-gray-300 px-2 py-0.5 rounded bg-white">
                            Reload Chat
                        </button>
                        <button onclick="clearConversation()"
                            class="text-[10px] font-bold text-gray-400 hover:text-red-500 transition-colors uppercase tracking-widest border border-gray-300 px-2 py-0.5 rounded bg-white">
                            Clear Memory
                        </button>
                    </div>
                </div>
                <div id="chatHistory" class="flex-1 p-3 overflow-y-auto text-sm space-y-2 bg-white">
                    <div class="text-green-600 font-bold">ASSAULTRON UNIT ASR-7 ONLINE - AWAITING OPERATOR COMMANDS
                    </div>
                </div>
                <div class="p-3 border-t border-gray-300 bg-gray-50">
                    <!-- Image Preview (shown when image selected) -->
                    <div id="imagePreviewContainer" class="hidden mb-2 relative inline-block">
                        <img id="imagePreview" src="" alt="Preview" class="max-h-20 rounded border border-gray-300">
                        <button id="clearImageBtn" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600">
                            Ã—
                        </button>
                    </div>
                    <div class="flex gap-2">
                        <input type="file" id="imageInput" accept="image/*" class="hidden">
                        <button id="attachImageBtn"
                            class="px-3 py-2 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300"
                            title="Attach Image">
                            ðŸ“Ž
                        </button>
                        <input type="text" id="chatInput" placeholder="ENTER COMMAND OR COMMUNICATION..."
                            class="flex-1 px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:border-blue-500">
                        <button id="sendBtn"
                            class="px-4 py-2 bg-blue-500 text-white rounded text-sm hover:bg-blue-600 disabled:bg-gray-400">
                            TRANSMIT
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Embodied Agent Tab Content -->
        <div id="embodiedTab" class="flex-1 flex flex-col tab-content hidden bg-gray-50 overflow-hidden">

            <div class="flex-1 overflow-y-auto p-4 lg:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6">

                <!-- LEFT COLUMN: PRIMARY SYSTEMS -->
                <div class="col-span-1 lg:col-span-4 space-y-6">

                    <!-- Brain Source (Toggle) -->
                    <div class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden transition-all hover:shadow-lg">
                        <div class="bg-gradient-to-r from-gray-800 to-gray-900 px-4 py-2.5 flex justify-between items-center">
                            <h3 class="font-bold text-white text-xs tracking-widest uppercase">Brain Source</h3>
                            <span id="providerBadge"
                                class="text-[10px] font-bold bg-blue-500 text-white px-2 py-0.5 rounded uppercase">Init</span>
                        </div>
                        <div class="p-4 bg-gradient-to-b from-gray-50 to-white">
                            <div class="flex p-1 bg-gray-200 rounded-lg shadow-inner">
                                <button onclick="setProvider('ollama')" id="btnOllama"
                                    class="flex-1 py-1.5 text-xs font-bold rounded text-center uppercase text-gray-500 hover:text-gray-900 transition-all">
                                    Local
                                </button>
                                <button onclick="setProvider('gemini')" id="btnGemini"
                                    class="flex-1 py-1.5 text-xs font-bold rounded text-center uppercase text-gray-500 hover:text-gray-900 transition-all">
                                    Gemini
                                </button>
                                <button onclick="setProvider('openrouter')" id="btnOpenRouter"
                                    class="flex-1 py-1.5 text-xs font-bold rounded text-center uppercase text-gray-500 hover:text-gray-900 transition-all">
                                    Router
                                </button>
                            </div>
                            <div class="mt-3 text-[10px] text-center text-gray-400 font-mono" id="currentModelDisplay">
                                Loading model info...
                            </div>
                        </div>
                    </div>

                    <!-- Voice Control -->
                    <div class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden transition-all hover:shadow-lg">
                        <div class="bg-gradient-to-r from-emerald-600 to-teal-600 px-4 py-2.5 flex justify-between items-center">
                            <h3 class="font-bold text-white text-xs tracking-widest uppercase">Vocal Synthesis</h3>
                            <div id="voiceStatusIndicator" class="h-2 w-2 rounded-full bg-red-300 shadow-lg"></div>
                        </div>
                        <div class="p-4 space-y-4">
                            <div class="flex justify-between items-start">
                                <div class="text-xs text-gray-500 space-y-1.5">
                                    <div class="flex items-center gap-2">
                                        <span class="w-12 text-gray-400 text-[10px] uppercase font-bold">Server</span>
                                        <span id="serverStatus" class="font-mono text-gray-800 bg-gray-100 px-2 py-0.5 rounded text-[10px]">Stopped</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="w-12 text-gray-400 text-[10px] uppercase font-bold">Model</span>
                                        <span id="modelStatus" class="font-mono text-gray-800 bg-gray-100 px-2 py-0.5 rounded text-[10px]">--</span>
                                    </div>
                                </div>
                                <span id="voiceStatusText"
                                    class="text-[10px] font-bold text-red-600 uppercase border border-red-300 px-2 py-1 rounded bg-red-50 shadow-sm">Offline</span>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <button id="voiceStartBtn" onclick="startVoiceServer()"
                                    class="flex items-center justify-center gap-1.5 px-3 py-2.5 bg-emerald-600 text-white rounded shadow-md text-xs font-bold hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all hover:shadow-lg">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z">
                                        </path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    INIT
                                </button>
                                <button id="voiceStopBtn" onclick="stopVoiceServer()"
                                    class="flex items-center justify-center gap-1.5 px-3 py-2.5 bg-red-600 text-white rounded shadow-md text-xs font-bold hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all hover:shadow-lg"
                                    disabled>
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z">
                                        </path>
                                    </svg>
                                    HALT
                                </button>
                            </div>

                            <div class="relative group">
                                <input type="text" id="testSpeechInput"
                                    placeholder="Enter text to synthesize sequence..."
                                    class="w-full pl-3 pr-16 py-2 border border-gray-300 rounded text-xs focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-gray-50 transition-all focus:bg-white text-gray-700">
                                <button onclick="testSpeech()"
                                    class="absolute right-1 top-1 bottom-1 px-3 bg-gray-200 text-gray-700 rounded text-[10px] font-bold hover:bg-emerald-500 hover:text-white transition-colors uppercase">TEST</button>
                            </div>
                        </div>
                    </div>

                    <!-- Notification System Control -->
                    <div class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden transition-all hover:shadow-lg">
                        <div class="bg-gradient-to-r from-orange-500 to-red-500 px-4 py-2.5 flex justify-between items-center">
                            <h3 class="font-bold text-white text-xs tracking-widest uppercase">Alert System</h3>
                            <div id="notificationStatusIndicator" class="h-2 w-2 rounded-full bg-green-300 shadow-lg"></div>
                        </div>
                        <div class="p-4 space-y-4">
                            <!-- Status Display -->
                            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-3 text-xs space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600 text-[10px] uppercase font-bold">Inactivity Monitor</span>
                                    <span id="inactivityStatus" class="font-bold text-green-600">ACTIVE</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600 text-[10px] uppercase font-bold">Threat Monitor</span>
                                    <span id="backgroundStatus" class="font-bold text-gray-400">INACTIVE</span>
                                </div>
                            </div>

                            <!-- Toggle Controls -->
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <label class="text-xs font-bold text-gray-700">Check-In Alerts</label>
                                    <button id="toggleInactivity" onclick="toggleInactivityMonitoring()"
                                        class="px-3 py-1.5 bg-green-600 text-white rounded text-[10px] font-bold hover:bg-green-700 transition-colors shadow-sm">
                                        ENABLED
                                    </button>
                                </div>
                                <div class="flex items-center justify-between">
                                    <label class="text-xs font-bold text-gray-700">Threat Alerts</label>
                                    <button id="toggleBackground" onclick="toggleBackgroundMonitoring()"
                                        class="px-3 py-1.5 bg-gray-400 text-white rounded text-[10px] font-bold hover:bg-gray-500 transition-colors shadow-sm">
                                        DISABLED
                                    </button>
                                </div>
                            </div>

                            <!-- Configuration -->
                            <div class="space-y-3 pt-3 border-t border-gray-200">
                                <div>
                                    <label class="text-[10px] font-bold text-gray-600 uppercase block mb-1.5">Min Interval (sec)</label>
                                    <input type="number" id="minInterval" value="30" min="10" max="300"
                                        class="w-full px-3 py-1.5 border border-gray-300 rounded text-xs focus:outline-none focus:ring-2 focus:ring-orange-500">
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-gray-600 uppercase block mb-1.5">Check-In Min (sec)</label>
                                    <input type="number" id="inactivityThresholdMin" value="300" min="60" max="3600"
                                        class="w-full px-3 py-1.5 border border-gray-300 rounded text-xs focus:outline-none focus:ring-2 focus:ring-orange-500">
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-gray-600 uppercase block mb-1.5">Check-In Max (sec)</label>
                                    <input type="number" id="inactivityThresholdMax" value="1800" min="300" max="3600"
                                        class="w-full px-3 py-1.5 border border-gray-300 rounded text-xs focus:outline-none focus:ring-2 focus:ring-orange-500">
                                </div>
                                <div class="text-[9px] text-gray-500 italic bg-gray-50 p-2 rounded">
                                    AI will check in randomly between min-max interval with personalized questions
                                </div>
                                <button onclick="updateNotificationConfig()"
                                    class="w-full px-3 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded text-xs font-bold hover:from-blue-700 hover:to-indigo-700 transition-all shadow-md">
                                    APPLY CONFIG
                                </button>
                            </div>

                            <!-- Test Button -->
                            <div class="pt-3 border-t border-gray-200">
                                <button onclick="testNotification()"
                                    class="w-full flex items-center justify-center gap-2 px-3 py-2.5 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded shadow-md text-xs font-bold hover:from-orange-600 hover:to-red-600 transition-all hover:shadow-lg">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                                        </path>
                                    </svg>
                                    SEND TEST ALERT
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Cognitive State Card -->
                    <div
                        class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden transition-all hover:shadow-lg">
                        <div
                            class="bg-gradient-to-r from-purple-700 to-indigo-700 px-4 py-2.5 flex justify-between items-center">
                            <h3 class="font-bold text-white text-xs tracking-widest uppercase">Cognitive Matrix</h3>
                            <span class="h-2 w-2 rounded-full bg-green-300 animate-pulse shadow-lg"></span>
                        </div>
                        <div class="p-4 space-y-4">
                            <!-- Goal & Focus -->
                            <div class="bg-gradient-to-br from-purple-50 to-indigo-50 p-3 rounded-lg border border-purple-200 shadow-sm">
                                <span
                                    class="text-[10px] uppercase text-purple-600 font-bold block mb-1 tracking-wider">Current
                                    Directive</span>
                                <span id="cogGoal"
                                    class="text-lg font-bold text-gray-800 block leading-tight">Idle</span>
                                <div class="mt-2 text-xs flex items-center gap-2">
                                    <span class="text-purple-500 font-bold">FOCUS:</span>
                                    <span id="cogFocus"
                                        class="bg-purple-200 text-purple-800 px-2 py-0.5 rounded text-[10px] font-mono">NULL</span>
                                </div>
                            </div>

                            <!-- Meters -->
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between text-xs mb-1.5">
                                        <span class="font-bold text-gray-600 uppercase text-[10px]">Confidence
                                            Calculation</span>
                                        <span id="cogConfidenceText"
                                            class="text-purple-700 font-mono font-bold">0.00</span>
                                    </div>
                                    <div class="h-2 bg-gray-100 rounded-full overflow-hidden border border-gray-200 shadow-inner">
                                        <div id="cogConfidenceBar"
                                            class="h-full bg-gradient-to-r from-purple-500 to-purple-600 transition-all duration-700 ease-out shadow-[0_0_10px_rgba(168,85,247,0.5)]"
                                            style="width: 0%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-xs mb-1.5">
                                        <span class="font-bold text-gray-600 uppercase text-[10px]">Action
                                            Urgency</span>
                                        <span id="cogUrgencyText" class="text-red-600 font-mono font-bold">0.00</span>
                                    </div>
                                    <div class="h-2 bg-gray-100 rounded-full overflow-hidden border border-gray-200 shadow-inner">
                                        <div id="cogUrgencyBar"
                                            class="h-full bg-gradient-to-r from-red-500 to-red-600 transition-all duration-700 ease-out shadow-[0_0_10px_rgba(239,68,68,0.5)]"
                                            style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Emotion Badge -->
                            <div class="flex items-center justify-between pt-3 border-t border-gray-200">
                                <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Emotional
                                    State</span>
                                <span id="cogEmotion"
                                    class="px-3 py-1 rounded-full text-xs font-bold bg-indigo-100 text-indigo-700 border border-indigo-200 uppercase tracking-wider shadow-sm">Neutral</span>
                            </div>
                        </div>
                    </div>

                    <!-- Mood State Card (Editable Internal State) -->
                    <div
                        class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden transition-all hover:shadow-lg">
                        <div
                            class="bg-gradient-to-r from-pink-600 to-rose-600 px-4 py-2.5 flex justify-between items-center">
                            <h3 class="font-bold text-white text-xs tracking-widest uppercase">Internal Mood State</h3>
                            <span class="h-2 w-2 rounded-full bg-pink-300 animate-pulse shadow-lg"></span>
                        </div>
                        <div class="p-4 space-y-3">
                            <div class="text-[10px] text-pink-600 font-bold uppercase tracking-wide mb-2 border-b border-pink-100 pb-2 flex justify-between items-center">
                                <span>ðŸ’­ Emotional State</span>
                                <span class="text-gray-400 text-[9px]">Persistent</span>
                            </div>

                            <!-- Mood Meters with Controls -->
                            <div class="space-y-3">
                                <!-- Curiosity -->
                                <div>
                                    <div class="flex justify-between text-xs mb-1.5">
                                        <span class="font-bold text-gray-600 uppercase text-[10px]">Curiosity</span>
                                        <span id="moodCuriosityText" class="text-blue-600 font-mono font-bold">0.50</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="range" id="moodCuriositySlider" min="0" max="100" value="50"
                                            class="flex-1 h-2 bg-gray-200 rounded-full appearance-none cursor-pointer accent-blue-500"
                                            onchange="updateMoodFromSlider('curiosity', this.value)">
                                        <div class="h-2 w-16 bg-gray-100 rounded-full overflow-hidden border border-gray-200 shadow-inner">
                                            <div id="moodCuriosityBar"
                                                class="h-full bg-blue-500 transition-all duration-300"
                                                style="width: 50%"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Irritation -->
                                <div>
                                    <div class="flex justify-between text-xs mb-1.5">
                                        <span class="font-bold text-gray-600 uppercase text-[10px]">Irritation</span>
                                        <span id="moodIrritationText" class="text-orange-600 font-mono font-bold">0.00</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="range" id="moodIrritationSlider" min="0" max="100" value="0"
                                            class="flex-1 h-2 bg-gray-200 rounded-full appearance-none cursor-pointer accent-orange-500"
                                            onchange="updateMoodFromSlider('irritation', this.value)">
                                        <div class="h-2 w-16 bg-gray-100 rounded-full overflow-hidden border border-gray-200 shadow-inner">
                                            <div id="moodIrritationBar"
                                                class="h-full bg-orange-500 transition-all duration-300"
                                                style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Boredom -->
                                <div>
                                    <div class="flex justify-between text-xs mb-1.5">
                                        <span class="font-bold text-gray-600 uppercase text-[10px]">Boredom</span>
                                        <span id="moodBoredomText" class="text-gray-600 font-mono font-bold">0.00</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="range" id="moodBoredomSlider" min="0" max="100" value="0"
                                            class="flex-1 h-2 bg-gray-200 rounded-full appearance-none cursor-pointer accent-gray-500"
                                            onchange="updateMoodFromSlider('boredom', this.value)">
                                        <div class="h-2 w-16 bg-gray-100 rounded-full overflow-hidden border border-gray-200 shadow-inner">
                                            <div id="moodBoredomBar"
                                                class="h-full bg-gray-500 transition-all duration-300"
                                                style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Attachment -->
                                <div>
                                    <div class="flex justify-between text-xs mb-1.5">
                                        <span class="font-bold text-gray-600 uppercase text-[10px]">Attachment</span>
                                        <span id="moodAttachmentText" class="text-pink-600 font-mono font-bold">0.30</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="range" id="moodAttachmentSlider" min="0" max="100" value="30"
                                            class="flex-1 h-2 bg-gray-200 rounded-full appearance-none cursor-pointer accent-pink-500"
                                            onchange="updateMoodFromSlider('attachment', this.value)">
                                        <div class="h-2 w-16 bg-gray-100 rounded-full overflow-hidden border border-gray-200 shadow-inner">
                                            <div id="moodAttachmentBar"
                                                class="h-full bg-pink-500 transition-all duration-300"
                                                style="width: 30%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Derived States -->
                            <div class="flex justify-between pt-3 border-t border-gray-200 text-[10px]">
                                <div class="flex flex-col gap-1 items-center">
                                    <span class="text-gray-500 uppercase font-bold">Engagement</span>
                                    <span id="moodEngagement" class="text-indigo-600 font-mono font-bold text-xs">50%</span>
                                </div>
                                <div class="flex flex-col gap-1 items-center">
                                    <span class="text-gray-500 uppercase font-bold">Stress</span>
                                    <span id="moodStress" class="text-red-600 font-mono font-bold text-xs">0%</span>
                                </div>
                                <div class="flex flex-col gap-1 items-center">
                                    <span class="text-gray-500 uppercase font-bold">Interactions</span>
                                    <span id="moodInteractionCount" class="text-gray-700 font-mono font-bold text-xs">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MIDDLE COLUMN: TELEMETRY & ENVIRONMENT -->
                <div class="col-span-1 lg:col-span-5 space-y-6">
                    <!-- Virtual Body Visualization -->
                    <div
                        class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden">
                        <div
                            class="bg-gradient-to-r from-blue-600 to-cyan-600 px-4 py-2.5 flex justify-between items-center shadow-sm">
                            <h3 class="font-bold text-white text-xs tracking-widest uppercase">Telemetry & Diagnostics
                            </h3>
                            <span class="h-2 w-2 rounded-full bg-cyan-300 shadow-lg"></span>
                        </div>

                        <div class="p-5 flex flex-col gap-5">
                            <!-- Head Unit -->
                            <div
                                class="bg-slate-50 rounded-lg p-4 border border-slate-200 relative overflow-hidden group">
                                <div
                                    class="absolute top-0 right-0 w-16 h-16 bg-blue-100 rounded-bl-full opacity-50 transition-opacity group-hover:opacity-100">
                                </div>
                                <div class="flex items-center justify-between relative z-10">
                                    <div class="flex items-center gap-4">
                                        <div
                                            class="p-3 bg-white rounded-full text-blue-600 shadow-sm border border-blue-50">
                                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                                    d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                                </path>
                                            </svg>
                                        </div>
                                        <div>
                                            <span
                                                class="text-[10px] font-bold text-slate-400 uppercase tracking-wider block mb-0.5">Primary
                                                Sensors</span>
                                            <div class="flex gap-3 text-xs">
                                                <span class="text-slate-600">Pan: <span id="bodyHeadPan"
                                                        class="font-mono font-bold text-blue-700">0Â°</span></span>
                                                <span class="text-slate-300">|</span>
                                                <span class="text-slate-600">Tilt: <span id="bodyHeadTilt"
                                                        class="font-mono font-bold text-blue-700">0Â°</span></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span id="bodyLuminance"
                                            class="inline-block px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wide bg-yellow-100 text-yellow-700 border border-yellow-200 shadow-sm">DIM</span>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <!-- Torso -->
                                <div
                                    class="p-4 border border-slate-200 rounded-lg bg-white shadow-[0_2px_8px_rgba(0,0,0,0.02)]">
                                    <h4
                                        class="text-[10px] font-bold text-slate-400 uppercase mb-3 flex items-center gap-2">
                                        <div class="w-1.5 h-1.5 rounded-full bg-blue-400"></div> Chassis
                                    </h4>
                                    <div class="space-y-2 text-xs">
                                        <div class="flex justify-between items-center"><span
                                                class="text-slate-500">Posture</span> <span id="bodyPosture"
                                                class="font-bold text-slate-700 bg-slate-100 px-2 py-0.5 rounded">Idle</span>
                                        </div>
                                        <div class="flex justify-between items-center"><span
                                                class="text-slate-500">Rotation</span> <span id="bodyTorsoRotation"
                                                class="font-mono text-slate-700 font-bold">0Â°</span></div>
                                        <div class="flex justify-between items-center"><span
                                                class="text-slate-500">Lean</span> <span id="bodyLeanAngle"
                                                class="font-mono text-slate-700 font-bold">0Â°</span></div>
                                    </div>
                                </div>

                                <!-- Locomotion -->
                                <div
                                    class="p-4 border border-slate-200 rounded-lg bg-white shadow-[0_2px_8px_rgba(0,0,0,0.02)]">
                                    <h4
                                        class="text-[10px] font-bold text-slate-400 uppercase mb-3 flex items-center gap-2">
                                        <div class="w-1.5 h-1.5 rounded-full bg-green-400"></div> Locomotion
                                    </h4>
                                    <div class="space-y-2 text-xs">
                                        <div class="flex justify-between items-center"><span
                                                class="text-slate-500">Stance</span> <span id="bodyLegStance"
                                                class="font-bold text-slate-700">Stable</span></div>
                                        <div class="flex justify-between items-center"><span
                                                class="text-slate-500">Balance</span> <span id="bodyBalance"
                                                class="font-bold text-emerald-600">100%</span></div>
                                        <div class="flex justify-between items-center"><span
                                                class="text-slate-500">Status</span> <span id="bodyMovement"
                                                class="font-bold text-xs uppercase bg-gray-100 px-2 py-0.5 rounded text-gray-600">STAT</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Arms -->
                            <div class="grid grid-cols-2 gap-4">
                                <div class="text-center bg-slate-50 p-3 rounded border border-slate-200">
                                    <span
                                        class="text-[10px] font-bold text-slate-400 block mb-2 uppercase tracking-wider">Left
                                        Actuator</span>
                                    <div id="bodyLeftHandPanel"
                                        class="bg-white py-1.5 rounded border border-slate-200 shadow-sm">
                                        <span id="bodyLeftHand"
                                            class="text-xs font-bold text-slate-700 uppercase">CLOSED</span>
                                    </div>
                                </div>
                                <div class="text-center bg-slate-50 p-3 rounded border border-slate-200">
                                    <span
                                        class="text-[10px] font-bold text-slate-400 block mb-2 uppercase tracking-wider">Right
                                        Actuator</span>
                                    <div id="bodyRightHandPanel"
                                        class="bg-white py-1.5 rounded border border-slate-200 shadow-sm">
                                        <span id="bodyRightHand"
                                            class="text-xs font-bold text-slate-700 uppercase">CLOSED</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- World Perception -->
                    <div class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden">
                        <div
                            class="bg-gradient-to-r from-emerald-500 to-teal-500 px-4 py-2.5 flex justify-between items-center">
                            <h3 class="font-bold text-white text-xs tracking-widest uppercase">Environmental
                                Sensors</h3>
                            <span class="h-2 w-2 rounded-full bg-emerald-300 shadow-lg"></span>
                        </div>
                        <div class="p-4 grid grid-cols-2 gap-4 text-sm">
                            <div
                                class="bg-gradient-to-br from-emerald-50 to-teal-50 rounded-lg p-3 border border-emerald-200 shadow-sm flex flex-col justify-between">
                                <span
                                    class="text-[10px] text-emerald-700 font-bold block uppercase tracking-wider mb-1">Threat
                                    Assessment</span>
                                <span id="worldThreat"
                                    class="text-xl font-bold text-emerald-800 uppercase leading-none">NONE</span>
                            </div>
                            <div
                                class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-3 border border-blue-200 shadow-sm flex flex-col justify-between">
                                <span
                                    class="text-[10px] text-blue-700 font-bold block uppercase tracking-wider mb-1">Temporal
                                    Data</span>
                                <span id="worldTime"
                                    class="text-xl font-bold text-blue-800 uppercase leading-none">--:--</span>
                            </div>
                            <div class="col-span-2 bg-gradient-to-br from-slate-50 to-gray-50 rounded-lg p-3 border border-slate-200 shadow-sm">
                                <span
                                    class="text-[10px] text-slate-600 font-bold block mb-2 uppercase tracking-wider">Detected
                                    Signatures</span>
                                <span id="worldEntities" class="text-slate-700 font-mono text-xs block break-words">No
                                    active signatures detected.</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: HARDWARE & MEMORY -->
                <div class="col-span-1 lg:col-span-3 space-y-6 flex flex-col h-full">
                    <!-- Hardware Debug -->
                    <div
                        class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-lg shadow-md overflow-hidden text-gray-300 text-xs border border-gray-700 transition-all hover:shadow-lg">
                        <div class="bg-black px-3 py-2 border-b border-gray-700 flex justify-between items-center">
                            <span class="font-mono text-orange-400 font-bold tracking-wider">HARDWARE_DEBUG</span>
                            <div class="w-2 h-2 rounded-full bg-orange-400 animate-pulse shadow-lg"></div>
                        </div>
                        <div class="p-3 font-mono space-y-2">
                            <div class="flex justify-between border-b border-gray-700 pb-1"><span>LED_INTENSITY</span>
                                <span id="motionLED" class="text-white font-bold">0%</span>
                            </div>
                            <div class="flex justify-between pt-1"><span>L_SERVO_POS</span> <span id="motionLeftPos"
                                    class="text-white">0</span></div>
                            <div class="flex justify-between"><span>R_SERVO_POS</span> <span id="motionRightPos"
                                    class="text-white">0</span></div>
                            <div class="flex justify-between border-t border-gray-700 pt-1 mt-1">
                                <span>MODE_SELECT</span> <span id="motionHandMode"
                                    class="text-yellow-400 font-bold">IDLE</span>
                            </div>
                        </div>
                    </div>

                    <!-- Core Memories Card -->
                    <div
                        class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden flex flex-col min-h-[300px] transition-all hover:shadow-lg">
                        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-3 py-2 flex justify-between items-center">
                            <h3 class="font-bold text-white text-[10px] tracking-widest uppercase">Core Memories</h3>
                            <div class="flex items-center gap-2">
                                <span id="memoryCountBadge"
                                    class="text-[10px] font-mono font-bold text-indigo-200">0/10</span>
                                <button onclick="addMemoryManual()" class="text-indigo-200 hover:text-green-300 transition-colors"
                                    title="Add Memory">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4v16m8-8H4"></path>
                                    </svg>
                                </button>
                                <button onclick="fetchLongTermMemories()" class="text-indigo-200 hover:text-cyan-300 transition-colors">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                        </path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div id="longTermMemoryList"
                            class="flex-1 overflow-y-auto bg-white scrollbar-thin scrollbar-thumb-gray-200">
                            <div class="p-4 text-center text-gray-300 italic text-xs">Accessing memory core...</div>
                        </div>
                    </div>

                    <!-- Behavior Logs -->
                    <div
                        class="flex-1 bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden flex flex-col min-h-[300px] transition-all hover:shadow-lg">
                        <div class="bg-gradient-to-r from-cyan-600 to-blue-600 px-3 py-2 flex justify-between items-center">
                            <h3 class="font-bold text-white text-[10px] tracking-widest uppercase">Decision Log</h3>
                            <button onclick="updateBehaviorHistory()" class="text-cyan-200 hover:text-white transition-colors"><svg
                                    class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                    </path>
                                </svg></button>
                        </div>
                        <div id="behaviorHistory"
                            class="flex-1 p-0 overflow-y-auto bg-white scrollbar-thin scrollbar-thumb-gray-200">
                            <div class="p-4 text-center text-gray-300 italic text-xs">System Initializing Sequence...
                            </div>
                        </div>
                    </div>

                    <!-- State Logs -->
                    <div
                        class="flex-1 bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden flex flex-col min-h-[200px] transition-all hover:shadow-lg">
                        <div class="bg-gradient-to-r from-teal-600 to-emerald-600 px-3 py-2">
                            <h3 class="font-bold text-white text-[10px] tracking-widest uppercase">State Transitions
                            </h3>
                        </div>
                        <div id="stateHistory" class="flex-1 p-0 overflow-y-auto bg-gray-50/50">
                            <div class="p-4 text-center text-gray-300 italic text-xs">Awaiting Input...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vision Tab Content -->
        <div id="visionTab" class="flex-1 flex flex-col tab-content hidden bg-gray-50 overflow-hidden">
            <div class="flex-1 overflow-y-auto p-4 lg:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6">

                <!-- Left: Camera Feed -->
                <div class="lg:col-span-8 space-y-4">
                    <!-- Camera Controls -->
                    <div class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden">
                        <div
                            class="bg-gradient-to-r from-blue-500 to-indigo-600 px-4 py-2 flex justify-between items-center">
                            <h3 class="font-bold text-white text-xs tracking-widest uppercase">Visual Feed</h3>
                            <div id="visionStatusIndicator" class="flex items-center gap-2">
                                <span id="visionFps" class="text-xs text-blue-100 font-mono">-- FPS</span>
                                <div class="h-2 w-2 rounded-full bg-red-500"></div>
                            </div>
                        </div>

                        <!-- Camera Controls Bar -->
                        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-center gap-4 flex-wrap">
                            <div class="flex items-center gap-2">
                                <label class="text-xs text-gray-600 uppercase tracking-wide">Camera:</label>
                                <select id="cameraSelect"
                                    class="bg-white text-gray-800 text-xs px-3 py-1.5 rounded border border-gray-300 focus:outline-none focus:border-blue-500">
                                    <option value="-1">No cameras</option>
                                </select>
                                <button onclick="refreshCameras()"
                                    class="p-1.5 bg-gray-200 text-gray-600 rounded hover:bg-gray-300"
                                    title="Refresh cameras">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                        </path>
                                    </svg>
                                </button>
                            </div>

                            <div class="flex items-center gap-3">
                                <button id="visionToggleBtn" onclick="toggleVision()"
                                    class="flex items-center gap-2 px-4 py-1.5 bg-emerald-600 text-white rounded text-xs font-bold hover:bg-emerald-700 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z">
                                        </path>
                                    </svg>
                                    <span id="visionToggleText">ACTIVATE</span>
                                </button>
                            </div>

                            <div class="flex items-center gap-2 ml-auto">
                                <label class="text-xs text-gray-600">Confidence:</label>
                                <input type="range" id="confidenceSlider" min="10" max="90" value="50"
                                    class="w-24 h-1 bg-gray-300 rounded-lg appearance-none cursor-pointer">
                                <span id="confidenceValue" class="text-xs text-blue-600 font-mono w-10">50%</span>
                            </div>
                        </div>

                        <!-- Video Feed -->
                        <div class="relative bg-gray-900 aspect-video flex items-center justify-center">
                            <img id="visionFrame" src="" alt="Vision Feed"
                                class="max-w-full max-h-full object-contain hidden">
                            <div id="visionPlaceholder" class="text-center text-gray-400">
                                <svg class="w-16 h-16 mx-auto mb-3 text-gray-500" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                        d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z">
                                    </path>
                                </svg>
                                <p class="text-sm font-bold uppercase tracking-wider">Vision Offline</p>
                                <p class="text-xs text-gray-500 mt-1">Select a camera and click ACTIVATE</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right: Detection Info -->
                <div class="lg:col-span-4 space-y-4">
                    <!-- Scene Analysis -->
                    <div class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden">
                        <div class="bg-gradient-to-r from-purple-500 to-pink-500 px-4 py-2">
                            <h3 class="font-bold text-white text-xs tracking-widest uppercase">Scene Analysis</h3>
                        </div>
                        <div class="p-4 space-y-4">
                            <!-- Scene Description -->
                            <div class="bg-gray-50 rounded p-3 border border-gray-200">
                                <span
                                    class="text-[10px] text-purple-600 font-bold uppercase tracking-wider block mb-2">AI
                                    Perception</span>
                                <p id="sceneDescription" class="text-gray-700 text-sm leading-relaxed">No visual input
                                    available.</p>
                            </div>

                            <!-- Stats Grid -->
                            <div class="grid grid-cols-2 gap-3">
                                <div class="bg-blue-50 rounded p-3 border border-blue-200 text-center">
                                    <span class="text-[10px] text-blue-600 font-bold uppercase block mb-1">People</span>
                                    <span id="personCount" class="text-2xl font-bold text-blue-600">0</span>
                                </div>
                                <div class="bg-orange-50 rounded p-3 border border-orange-200 text-center">
                                    <span
                                        class="text-[10px] text-orange-600 font-bold uppercase block mb-1">Objects</span>
                                    <span id="objectCount" class="text-2xl font-bold text-orange-600">0</span>
                                </div>
                            </div>

                            <!-- Threat Level -->
                            <div class="bg-gray-50 rounded p-3 border border-gray-200">
                                <div class="flex justify-between items-center">
                                    <span class="text-[10px] text-gray-600 font-bold uppercase">Threat Assessment</span>
                                    <span id="visionThreatLevel"
                                        class="px-2 py-0.5 rounded text-xs font-bold uppercase bg-green-100 text-green-700 border border-green-300">NONE</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detected Entities -->
                    <div class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden flex-1">
                        <div class="bg-gray-100 px-4 py-2 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="font-bold text-gray-700 text-xs tracking-widest uppercase">Detected Entities</h3>
                            <span id="entityCount" class="text-xs text-gray-500 font-mono">0 detected</span>
                        </div>
                        <div id="entityList" class="p-2 max-h-64 overflow-y-auto space-y-1 bg-white">
                            <div class="text-center text-gray-400 text-xs py-4 italic">No entities detected</div>
                        </div>
                    </div>

                    <!-- Vision System Info -->
                    <div class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden">
                        <div class="bg-gray-100 px-4 py-2 border-b border-gray-200">
                            <h3 class="font-bold text-gray-700 text-xs tracking-widest uppercase">System Info</h3>
                        </div>
                        <div class="p-3 space-y-2 text-xs">
                            <div class="flex justify-between">
                                <span class="text-gray-500">Status</span>
                                <span id="visionSystemStatus" class="text-red-600 font-bold">OFFLINE</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Processing</span>
                                <span id="visionProcessingTime" class="text-gray-700 font-mono">-- ms</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Resolution</span>
                                <span id="visionResolution" class="text-gray-700 font-mono">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Model</span>
                                <span class="text-gray-700 font-mono">YOLOv8n</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Bottom Stats Section -->
        <div class="border-t border-gray-300 bg-gray-50 p-3">
            <div class="grid grid-cols-6 gap-4 text-xs">
                <div class="text-center">
                    <div class="text-gray-500">API Status</div>
                    <div id="apiStatus" class="font-bold text-red-500">Offline</div>
                </div>
                <div class="text-center">
                    <div class="text-gray-500">Response Time</div>
                    <div id="responseTime" class="font-bold">-</div>
                </div>
                <div class="text-center">
                    <div class="text-gray-500">Ping</div>
                    <div id="ping" class="font-bold">-</div>
                </div>
                <div class="text-center">
                    <div class="text-gray-500">Messages</div>
                    <div id="messageCount" class="font-bold">0</div>
                </div>
                <div class="text-center">
                    <div class="text-gray-500">Model</div>
                    <div id="modelName" class="font-bold">-</div>
                </div>
                <div class="text-center">
                    <div class="text-gray-500">Uptime</div>
                    <div id="uptime" class="font-bold">-</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Immersion Mode Overlay -->
    <div id="immersionMode" class="immersion-overlay hidden">
        <button onclick="toggleImmersionMode()" class="immersion-close-btn">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>

        <!-- Sound Visualizer -->
        <div class="immersion-visualizer-container">
            <canvas id="soundVisualizer" class="sound-visualizer"></canvas>
        </div>

        <!-- Chat History (Faded at bottom) -->
        <div id="immersionChatHistory" class="immersion-chat-history"></div>

        <!-- Chat Input Bar -->
        <div class="immersion-input-container">
            <!-- Image Preview (shown when image selected) -->
            <div id="immersionImagePreviewContainer" class="hidden" style="position: absolute; bottom: 70px; left: 20px;">
                <div style="position: relative; display: inline-block;">
                    <img id="immersionImagePreview" src="" alt="Preview" style="max-height: 80px; border-radius: 8px; border: 2px solid rgba(255,255,255,0.3);">
                    <button id="immersionClearImageBtn" style="position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border-radius: 50%; width: 24px; height: 24px; border: none; cursor: pointer; font-size: 16px; line-height: 1;">
                        Ã—
                    </button>
                </div>
            </div>
            <input type="file" id="immersionImageInput" accept="image/*" class="hidden">
            <button id="immersionAttachImageBtn" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 10px 15px; border-radius: 4px; cursor: pointer; margin-right: 10px; font-size: 18px;">
                ðŸ“Ž
            </button>
            <input type="text" id="immersionChatInput" placeholder="ENTER COMMAND OR COMMUNICATION..."
                class="immersion-chat-input">
            <button id="immersionSendBtn" class="immersion-send-btn">
                TRANSMIT
            </button>
        </div>
    </div>

    <script>
        // Global state
        let messageCount = 0;
        let startTime = Date.now();
        let lastPingTime = 0;
        let currentTab = 'interface';

        // Voice audio playback state
        let lastPlayedAudioUrl = null;
        let audioPlayer = null;
        let audioQueue = [];

        // Web Audio API for real-time audio analysis
        let audioContext = null;
        let audioAnalyser = null;
        let audioSource = null;
        let audioDataArray = null;
        let audioBufferLength = 0;

        // DOM elements
        const logsPanel = document.getElementById('logsPanel');
        const chatPanel = document.getElementById('chatPanel');
        const resizeHandle = document.getElementById('resizeHandle');
        const systemLogs = document.getElementById('systemLogs');
        const chatHistory = document.getElementById('chatHistory');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');

        // Image upload elements
        const imageInput = document.getElementById('imageInput');
        const attachImageBtn = document.getElementById('attachImageBtn');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const clearImageBtn = document.getElementById('clearImageBtn');

        // Immersion mode image elements
        const immersionImageInput = document.getElementById('immersionImageInput');
        const immersionAttachImageBtn = document.getElementById('immersionAttachImageBtn');
        const immersionImagePreviewContainer = document.getElementById('immersionImagePreviewContainer');
        const immersionImagePreview = document.getElementById('immersionImagePreview');
        const immersionClearImageBtn = document.getElementById('immersionClearImageBtn');

        // Stats elements
        const apiStatus = document.getElementById('apiStatus');
        const responseTimeEl = document.getElementById('responseTime');
        const pingEl = document.getElementById('ping');
        const messageCountEl = document.getElementById('messageCount');
        const modelNameEl = document.getElementById('modelName');
        const uptimeEl = document.getElementById('uptime');

        // Panel resizing
        let isResizing = false;

        resizeHandle.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.addEventListener('mousemove', handleResize);
            document.addEventListener('mouseup', stopResize);
        });

        function handleResize(e) {
            if (!isResizing) return;

            const containerWidth = window.innerWidth;
            const newWidth = (e.clientX / containerWidth) * 100;

            if (newWidth > 20 && newWidth < 80) {
                logsPanel.style.width = `${newWidth}%`;
            }
        }

        function stopResize() {
            isResizing = false;
            document.removeEventListener('mousemove', handleResize);
            document.removeEventListener('mouseup', stopResize);
        }

        // Image attachment handling
        function clearSelectedImage() {
            imageInput.value = '';
            imagePreviewContainer.classList.add('hidden');
            imagePreview.src = '';
        }

        function clearImmersionImage() {
            immersionImageInput.value = '';
            immersionImagePreviewContainer.classList.add('hidden');
            immersionImagePreview.src = '';
        }

        attachImageBtn.addEventListener('click', () => {
            imageInput.click();
        });

        immersionAttachImageBtn.addEventListener('click', () => {
            immersionImageInput.click();
        });

        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreviewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        immersionImageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    immersionImagePreview.src = e.target.result;
                    immersionImagePreviewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        clearImageBtn.addEventListener('click', clearSelectedImage);
        immersionClearImageBtn.addEventListener('click', clearImmersionImage);

        // Logging
        function addLog(level, message) {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                INFO: 'text-blue-600',
                WARN: 'text-yellow-600',
                WARNING: 'text-orange-600',
                ERROR: 'text-red-600',
                AI: 'text-green-600',
                COGNITIVE: 'text-purple-600',
                BEHAVIOR: 'text-indigo-600',
                MOTION: 'text-orange-600',
                WORLD: 'text-green-600',
                CONTEXT: 'text-purple-600',
                ACTION: 'text-indigo-600',
                TOOL: 'text-teal-600',
                VOICE: 'text-pink-600',
                MANUAL: 'text-gray-600',
                MEMORY: 'text-purple-400'
            };

            const logDiv = document.createElement('div');
            logDiv.className = colors[level] || 'text-gray-600';
            logDiv.textContent = `[${timestamp}] [${level}] ${message}`;

            systemLogs.appendChild(logDiv);
            systemLogs.scrollTop = systemLogs.scrollHeight;

            // Keep only last 100 logs
            while (systemLogs.children.length > 100) {
                systemLogs.removeChild(systemLogs.firstChild);
            }
        }

        // Chat functions
        function addChatMessage(sender, message, timestamp, imagePath = null) {
            const timeStr = timestamp || new Date().toLocaleTimeString();
            const div = document.createElement('div');

            let imageHtml = '';
            if (imagePath) {
                // Normalize path separators (Windows uses backslash, web needs forward slash)
                const webPath = imagePath.replace(/\\/g, '/');
                // Create clickable image thumbnail
                imageHtml = `<br><img src="/${webPath}" alt="Attached image" class="mt-2 max-w-xs max-h-48 rounded border border-gray-300 cursor-pointer" onclick="window.open('/${webPath}', '_blank')">`;
            }

            if (sender === 'USER') {
                div.innerHTML = `<div class="text-right"><span class="text-gray-500">[${timeStr}]</span> <span class="text-blue-600 font-bold">OPERATOR:</span> ${message}${imageHtml}</div>`;
            } else if (sender === 'ASSAULTRON') {
                div.innerHTML = `<div><span class="text-gray-500">[${timeStr}]</span> <span class="text-green-600 font-bold">ASR-7:</span> ${message}</div>`;
            } else {
                div.innerHTML = `<div><span class="text-gray-500">[${timeStr}]</span> <span class="text-gray-600 font-bold">${sender}:</span> ${message}</div>`;
            }

            chatHistory.appendChild(div);
            // Wait for next frame to ensure scrollHeight is updated
            requestAnimationFrame(() => {
                chatHistory.scrollTop = chatHistory.scrollHeight;
            });
        }

        async function loadHistory() {
            try {
                const response = await fetch('/api/history');
                if (response.ok) {
                    const history = await response.json();
                    if (history.length > 0) {
                        chatHistory.innerHTML = ''; // Clear the initial online message
                        history.forEach(exchange => {
                            const timeStr = exchange.timestamp ? new Date(exchange.timestamp).toLocaleTimeString() : null;
                            if (exchange.user) addChatMessage('USER', exchange.user, timeStr, exchange.image_path);
                            if (exchange.assistant) addChatMessage('ASSAULTRON', exchange.assistant, timeStr);
                        });
                        addLog('SYSTEM', 'Conversation history restored');
                    }
                }
            } catch (error) {
                addLog('ERROR', 'Failed to load conversation history');
            }
        }

        async function reloadConversation() {
            try {
                addLog('INFO', 'Reloading conversation from file...');
                const response = await fetch('/api/history');
                if (response.ok) {
                    const history = await response.json();
                    chatHistory.innerHTML = ''; // Clear current chat display
                    if (history.length > 0) {
                        history.forEach(exchange => {
                            const timeStr = exchange.timestamp ? new Date(exchange.timestamp).toLocaleTimeString() : null;
                            if (exchange.user) addChatMessage('USER', exchange.user, timeStr);
                            if (exchange.assistant) addChatMessage('ASSAULTRON', exchange.assistant, timeStr);
                        });
                        addLog('SUCCESS', `Conversation reloaded (${history.length} messages)`);
                    } else {
                        addLog('INFO', 'No conversation history found');
                    }
                }
            } catch (error) {
                addLog('ERROR', `Failed to reload conversation: ${error.message}`);
            }
        }

        async function clearConversation() {
            if (!confirm("Are you sure you want to clear the conversation memory?")) return;

            try {
                const response = await fetch('/api/history/clear', { method: 'POST' });
                if (response.ok) {
                    chatHistory.innerHTML = '<div class="text-green-600 font-bold">ASSAULTRON UNIT ASR-7 ONLINE - MEMORY PURGED - AWAITING COMMANDS</div>';
                    addLog('SYSTEM', 'Conversation history cleared');
                }
            } catch (error) {
                addLog('ERROR', 'Failed to clear conversation history');
            }
        }

        // Mark user as active to prevent notifications during chat
        // Throttled to max once per 10 seconds to avoid excessive API calls
        let lastUserActiveCall = 0;
        const USER_ACTIVE_THROTTLE_MS = 10000; // 10 seconds

        async function markUserActive() {
            const now = Date.now();

            // Throttle: only call if enough time has passed since last call
            if (now - lastUserActiveCall < USER_ACTIVE_THROTTLE_MS) {
                return; // Skip this call
            }

            lastUserActiveCall = now;

            try {
                await fetch('/api/notifications/user_active', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
            } catch (error) {
                // Silently fail - not critical
                console.log('Failed to mark user active:', error);
            }
        }

        // API functions
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            // Mark user as active when sending a message
            markUserActive();

            // Save reference to image file before clearing input
            let imagePath = null;
            let imageFile = null;
            const imageInput = document.getElementById('imageInput');
            if (imageInput.files.length > 0) {
                imageFile = imageInput.files[0];
            }

            chatInput.value = '';
            sendBtn.disabled = true;
            sendBtn.textContent = 'TRANSMITTING';

            const startTime = performance.now();

            // If immersion mode is active, start visualizer immediately
            if (immersionModeActive) {
                isAISpeaking = true;
            }

            try {
                addLog('AI', `Sending: ${message.substring(0, 50)}...`);

                // Handle image upload if present
                if (imageFile) {
                    const formData = new FormData();
                    formData.append('image', imageFile);

                    addLog('AI', 'Uploading image...');
                    const uploadResponse = await fetch('/api/chat/upload_image', {
                        method: 'POST',
                        body: formData
                    });

                    if (uploadResponse.ok) {
                        const uploadData = await uploadResponse.json();
                        imagePath = uploadData.image_path;
                        addLog('AI', `Image uploaded: ${uploadData.filename}`);
                    } else {
                        throw new Error('Image upload failed');
                    }

                    // Clear the image
                    clearSelectedImage();
                }

                // Now add the user message with the image path
                addChatMessage('USER', message, null, imagePath);

                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        image_path: imagePath
                    })
                });

                const endTime = performance.now();
                const responseTime = Math.round(endTime - startTime);

                if (response.ok) {
                    const data = await response.json();
                    addChatMessage('ASSAULTRON', data.response);
                    messageCount++;
                    messageCountEl.textContent = messageCount;
                    responseTimeEl.textContent = `${responseTime}ms`;

                    const provider = data.provider ? data.provider.toUpperCase() : 'AI';
                    addLog('AI', `Response received from ${provider} (${responseTime}ms)`);

                    // Log cognitive state if available
                    if (data.cognitive_state) {
                        addLog('COGNITIVE', `Goal: ${data.cognitive_state.goal}, Emotion: ${data.cognitive_state.emotion}`);
                    }

                    // If immersion mode is active, add message and handle visualizer
                    if (immersionModeActive) {
                        // Only add if not already added via sendImmersionMessage
                        const lastMsg = document.getElementById('immersionChatHistory').lastChild;
                        if (!lastMsg || !lastMsg.textContent.includes(data.response.substring(0, 20))) {
                            addImmersionMessage('ASSAULTRON', data.response);
                        }

                        // Keep visualizer active for duration based on response
                        if (!data.voice_enabled) {
                            const speakDuration = Math.min(data.response.length * 50, 10000);
                            setTimeout(() => {
                                isAISpeaking = false;
                            }, speakDuration);
                        }
                    }

                    // Update embodied agent display if on that tab
                    if (currentTab === 'embodied') {
                        updateEmbodiedAgentData();
                    }
                } else {
                    if (immersionModeActive) {
                        isAISpeaking = false;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }

            } catch (error) {
                addChatMessage('SYSTEM', `Error: ${error.message}`);
                addLog('ERROR', `Chat failed: ${error.message}`);
                responseTimeEl.textContent = 'Error';
                if (immersionModeActive) {
                    isAISpeaking = false;
                }
            }

            sendBtn.disabled = false;
            sendBtn.textContent = 'TRANSMIT';
        }

        async function updateStats() {
            const pingStart = performance.now();

            try {
                const response = await fetch('/api/status');
                const pingEnd = performance.now();
                const ping = Math.round(pingEnd - pingStart);

                if (response.ok) {
                    const data = await response.json();

                    // Update status indicators
                    if (data.ai_active) {
                        apiStatus.textContent = 'Online';
                        apiStatus.className = 'font-bold text-green-500';
                    } else {
                        apiStatus.textContent = 'Offline';
                        apiStatus.className = 'font-bold text-red-500';
                    }

                    pingEl.textContent = `${ping}ms`;
                    pingEl.className = ping < 100 ? 'font-bold text-green-500' :
                        ping < 500 ? 'font-bold text-yellow-500' : 'font-bold text-red-500';

                    // Update other stats
                    messageCountEl.textContent = data.conversation_count || messageCount;

                    // NEW: Update provider and model info in real-time
                    if (data.model) {
                        modelNameEl.textContent = data.model;
                        if (data.provider === 'gemini') {
                            modelNameEl.className = 'font-bold text-blue-500';
                        } else if (data.provider === 'openrouter') {
                            modelNameEl.className = 'font-bold text-purple-500';
                        } else {
                            modelNameEl.className = 'font-bold text-green-500';
                        }
                    }

                } else {
                    throw new Error('Status check failed');
                }

            } catch (error) {
                apiStatus.textContent = 'Error';
                apiStatus.className = 'font-bold text-red-500';
                pingEl.textContent = 'Error';
                // Don't spam log for regular background polling
            }
        }

        async function getModelInfo() {
            // Now simply triggers updateStats which handles model info
            await updateStats();
        }

        function updateUptime() {
            const elapsed = Date.now() - startTime;
            const seconds = Math.floor(elapsed / 1000) % 60;
            const minutes = Math.floor(elapsed / 60000) % 60;
            const hours = Math.floor(elapsed / 3600000);

            uptimeEl.textContent = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Event listeners
        sendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Mark user as active when interacting with chat
        chatInput.addEventListener('focus', markUserActive);
        chatInput.addEventListener('input', markUserActive);
        chatHistory.addEventListener('scroll', markUserActive);

        // Periodically mark user as active while viewing the page (every 30 seconds)
        let activityInterval = setInterval(() => {
            // Only mark active if user has interacted recently
            if (document.hasFocus()) {
                markUserActive();
            }
        }, 30000);

        // Voice system event listeners
        document.getElementById('testSpeechInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') testSpeech();
        });

        // Tab Management
        function switchTab(tabName) {
            currentTab = tabName;

            // Hide all tabs
            document.getElementById('interfaceTab').classList.toggle('hidden', tabName !== 'interface');
            document.getElementById('embodiedTab').classList.toggle('hidden', tabName !== 'embodied');
            document.getElementById('visionTab').classList.toggle('hidden', tabName !== 'vision');

            // Update tab buttons
            const tabs = ['Interface', 'Embodied', 'Vision'];
            tabs.forEach(tab => {
                const tabEl = document.getElementById(`tab${tab}`);
                const isActive = tabName === tab.toLowerCase();
                tabEl.classList.toggle('active', isActive);
                tabEl.classList.toggle('border-blue-500', isActive);
                tabEl.classList.toggle('border-transparent', !isActive);
            });

            if (tabName === 'embodied') {
                updateEmbodiedAgentData();
                fetchLongTermMemories();
            }

            if (tabName === 'vision') {
                refreshCameras();
                updateVisionData();
            }
        }


        // Voice System Functions
        async function startVoiceServer() {
            const startBtn = document.getElementById('voiceStartBtn');
            const stopBtn = document.getElementById('voiceStopBtn');

            try {
                startBtn.disabled = true;
                startBtn.textContent = 'STARTING...';

                addLog('VOICE', 'Starting Assaultron voice system...');
                updateVoiceStatus(false, 'Starting...', 'Starting', 'Loading');

                const response = await fetch('/api/voice/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    addLog('VOICE', 'Voice system started successfully!');
                    updateVoiceStatus(true, 'Online', 'Running', 'Loaded');

                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    startBtn.textContent = 'ONLINE';
                } else {
                    throw new Error(data.error || 'Failed to start voice system');
                }

            } catch (error) {
                addLog('ERROR', `Voice system startup failed: ${error.message}`);
                updateVoiceStatus(false, 'Offline', 'Stopped', 'Not loaded');

                startBtn.disabled = false;
                startBtn.textContent = 'START';
            }
        }

        async function stopVoiceServer() {
            const startBtn = document.getElementById('voiceStartBtn');
            const stopBtn = document.getElementById('voiceStopBtn');

            try {
                stopBtn.disabled = true;
                stopBtn.textContent = 'STOPPING...';

                addLog('VOICE', 'Stopping voice system...');

                const response = await fetch('/api/voice/stop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    addLog('VOICE', 'Voice system stopped');
                    updateVoiceStatus(false, 'Offline', 'Stopped', 'Not loaded');

                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    startBtn.textContent = 'START';
                    stopBtn.textContent = 'STOP';
                } else {
                    throw new Error(data.error || 'Failed to stop voice system');
                }

            } catch (error) {
                addLog('ERROR', `Voice system stop failed: ${error.message}`);
                stopBtn.disabled = false;
                stopBtn.textContent = 'STOP';
            }
        }

        function updateVoiceStatus(enabled, statusText, serverStatus, modelStatus) {
            const statusTextEl = document.getElementById('voiceStatusText');
            const statusIndicator = document.getElementById('voiceStatusIndicator');
            const serverStatusEl = document.getElementById('serverStatus');
            const modelStatusEl = document.getElementById('modelStatus');

            // Update main status
            statusTextEl.textContent = statusText;
            statusTextEl.className = enabled ? 'text-green-500' : 'text-red-500';

            // Update status indicator
            statusIndicator.className = enabled ?
                'w-2 h-2 rounded-full bg-green-500 animate-pulse' :
                'w-2 h-2 rounded-full bg-red-500';

            // Update detailed status
            serverStatusEl.textContent = serverStatus;
            modelStatusEl.textContent = modelStatus;
        }

        async function testSpeechInternal(text) {
            try {
                addLog('VOICE', `Testing speech: "${text}"`);

                const response = await fetch('/api/voice/speak', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });

                const data = await response.json();

                if (data.success) {
                    addLog('VOICE', 'Speech synthesis started');
                    return true;
                } else {
                    throw new Error(data.error || 'Speech synthesis failed');
                }

            } catch (error) {
                addLog('ERROR', `Speech test failed: ${error.message}`);
                return false;
            }
        }

        async function testSpeech() {
            const testInput = document.getElementById('testSpeechInput');
            const text = testInput.value.trim();

            if (!text) {
                addLog('WARNING', 'No test text provided');
                return;
            }

            const success = await testSpeechInternal(text);
            if (success) {
                testInput.value = ''; // Clear input on success
            }
        }

        async function updateVoiceSystemStatus() {
            try {
                const response = await fetch('/api/voice/status');
                if (response.ok) {
                    const status = await response.json();

                    const enabled = status.voice_enabled && status.initialized && status.server_running;
                    const statusText = enabled ?
                        `Voice system online (${status.model_info?.name || 'Unknown Model'})` :
                        'Voice system offline';

                    const serverStatus = status.server_running ? 'Running' : 'Stopped';
                    const modelStatus = status.model_loaded ?
                        (status.model_info?.name ? `${status.model_info.name} (${status.model_info.type})` : 'Loaded') :
                        'Not loaded';

                    updateVoiceStatus(enabled, statusText, serverStatus, modelStatus);

                    // Update button states
                    const startBtn = document.getElementById('voiceStartBtn');
                    const stopBtn = document.getElementById('voiceStopBtn');

                    if (enabled) {
                        startBtn.disabled = true;
                        startBtn.textContent = 'âœ… VOICE ONLINE';
                        stopBtn.disabled = false;
                    } else {
                        startBtn.disabled = false;
                        startBtn.textContent = 'ðŸš€ START VOICE SERVER';
                        stopBtn.disabled = true;
                    }

                    // Check for new audio to play
                    if (status.last_audio_url && status.last_audio_url !== lastPlayedAudioUrl) {
                        playVoiceAudio(status.last_audio_url);
                        lastPlayedAudioUrl = status.last_audio_url;
                    }
                }
            } catch (error) {
                // Silently fail for status updates to avoid spam
                console.log('Voice status update failed:', error.message);
            }
        }

        function initAudioAnalyser() {
            try {
                // Create audio context if it doesn't exist
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                // Create analyser node
                if (!audioAnalyser) {
                    audioAnalyser = audioContext.createAnalyser();
                    audioAnalyser.fftSize = 256; // 256 samples for frequency analysis
                    audioBufferLength = audioAnalyser.frequencyBinCount; // Will be 128 (half of fftSize)
                    audioDataArray = new Uint8Array(audioBufferLength);
                    audioAnalyser.connect(audioContext.destination);
                }

                return true;
            } catch (error) {
                console.error('Failed to initialize audio analyser:', error);
                return false;
            }
        }

        function playVoiceAudio(audioUrl) {
            try {
                // Initialize Web Audio API
                if (!initAudioAnalyser()) {
                    addLog('ERROR', 'Failed to initialize audio analyser');
                    return;
                }

                // Create audio player if it doesn't exist
                if (!audioPlayer) {
                    audioPlayer = new Audio();

                    // Event listeners
                    audioPlayer.addEventListener('play', () => {
                        isAISpeaking = true;
                        if (audioContext.state === 'suspended') {
                            audioContext.resume();
                        }
                    });

                    audioPlayer.addEventListener('ended', () => {
                        isAISpeaking = false;
                    });

                    audioPlayer.addEventListener('pause', () => {
                        isAISpeaking = false;
                    });

                    audioPlayer.addEventListener('error', (e) => {
                        addLog('ERROR', 'Failed to play voice audio');
                        isAISpeaking = false;
                    });
                }

                // Connect to Web Audio API analyser (only create once)
                if (!audioSource) {
                    audioSource = audioContext.createMediaElementSource(audioPlayer);
                    audioSource.connect(audioAnalyser);
                }

                // Play the audio
                audioPlayer.src = audioUrl;
                audioPlayer.play().then(() => {
                    addLog('VOICE', 'Playing synthesized voice');
                }).catch(err => {
                    addLog('ERROR', `Voice playback failed: ${err.message}`);
                    isAISpeaking = false;
                });
            } catch (error) {
                addLog('ERROR', `Voice playback error: ${error.message}`);
                isAISpeaking = false;
            }
        }

        // Embodied Agent Functions
        async function updateEmbodiedAgentData() {
            await Promise.all([
                updateVirtualWorld(),
                updateBehaviorHistory(),
                updateStateHistory()
            ]);
        }

        async function updateVirtualWorld() {
            try {
                const response = await fetch('/api/embodied/virtual_world');
                if (response.ok) {
                    const data = await response.json();

                    // Update cognitive state
                    if (data.cognitive_state) {
                        document.getElementById('cogGoal').textContent = data.cognitive_state.goal || 'Idle';
                        document.getElementById('cogEmotion').textContent = data.cognitive_state.emotion || 'Neutral';

                        const confidence = (data.cognitive_state.confidence || 0);
                        const urgency = (data.cognitive_state.urgency || 0);

                        // Update text
                        document.getElementById('cogConfidenceText').textContent = confidence.toFixed(2);
                        document.getElementById('cogUrgencyText').textContent = urgency.toFixed(2);

                        // Update progress bars
                        document.getElementById('cogConfidenceBar').style.width = `${confidence * 100}%`;
                        document.getElementById('cogUrgencyBar').style.width = `${urgency * 100}%`;

                        document.getElementById('cogFocus').textContent = data.cognitive_state.focus || 'NULL';
                    }

                    // Update body state
                    if (data.body_state) {
                        document.getElementById('bodyPosture').textContent = data.body_state.posture || 'Idle';
                        document.getElementById('bodyLuminance').textContent = data.body_state.luminance || 'DIM';
                        document.getElementById('bodyLeftHand').textContent = data.body_state.left_hand || 'CLOSED';
                        document.getElementById('bodyRightHand').textContent = data.body_state.right_hand || 'CLOSED';
                        // Removed bodyAttention from new UI or mapped elsewhere if needed

                        document.getElementById('bodyHeadPan').textContent = (data.body_state.head_pan || 0) + 'Â°';
                        document.getElementById('bodyHeadTilt').textContent = (data.body_state.head_tilt || 0) + 'Â°';
                        document.getElementById('bodyTorsoRotation').textContent = (data.body_state.torso_rotation || 0) + 'Â°';
                        document.getElementById('bodyLeanAngle').textContent = (data.body_state.lean_angle || 0) + 'Â°';

                        document.getElementById('bodyLegStance').textContent = data.body_state.leg_stance || 'Stable';
                        document.getElementById('bodyBalance').textContent = (data.body_state.balance || 100) + '%';
                        document.getElementById('bodyMovement').textContent = data.body_state.movement || 'STAT';
                    }

                    // Update world state
                    if (data.world_state) {
                        // worldEnv removed from main view to save space, can add back if requested
                        document.getElementById('worldThreat').textContent = data.world_state.threat_level || 'NONE';

                        const entities = data.world_state.entities || [];
                        const entitiesText = entities.length > 0 ? entities.join(', ') : 'No active signatures detected.';
                        document.getElementById('worldEntities').textContent = entitiesText;

                        document.getElementById('worldTime').textContent = data.world_state.time_of_day || 'UNKNOWN';
                    }

                    // Update mood state (internal, emergent)
                    if (data.mood_state) {
                        const mood = data.mood_state;

                        // Update curiosity
                        document.getElementById('moodCuriosityText').textContent = mood.curiosity.toFixed(2);
                        document.getElementById('moodCuriosityBar').style.width = `${mood.curiosity * 100}%`;

                        // Update irritation
                        document.getElementById('moodIrritationText').textContent = mood.irritation.toFixed(2);
                        document.getElementById('moodIrritationBar').style.width = `${mood.irritation * 100}%`;

                        // Update boredom
                        document.getElementById('moodBoredomText').textContent = mood.boredom.toFixed(2);
                        document.getElementById('moodBoredomBar').style.width = `${mood.boredom * 100}%`;

                        // Update attachment
                        document.getElementById('moodAttachmentText').textContent = mood.attachment.toFixed(2);
                        document.getElementById('moodAttachmentBar').style.width = `${mood.attachment * 100}%`;

                        // Update derived states
                        document.getElementById('moodEngagement').textContent = `${Math.round(mood.engagement * 100)}%`;
                        document.getElementById('moodStress').textContent = `${Math.round(mood.stress * 100)}%`;
                        document.getElementById('moodInteractionCount').textContent = mood.interaction_count || 0;

                        // Update sliders without triggering onchange
                        document.getElementById('moodCuriositySlider').value = Math.round(mood.curiosity * 100);
                        document.getElementById('moodIrritationSlider').value = Math.round(mood.irritation * 100);
                        document.getElementById('moodBoredomSlider').value = Math.round(mood.boredom * 100);
                        document.getElementById('moodAttachmentSlider').value = Math.round(mood.attachment * 100);
                    }

                    // Update motion/hardware state (from last hardware state)
                    const hwResponse = await fetch('/api/hardware');
                    if (hwResponse.ok) {
                        const hwData = await hwResponse.json();
                        document.getElementById('motionLED').textContent = `${hwData.led_intensity}%`;
                        document.getElementById('motionLeftPos').textContent = hwData.hands.left.position;
                        document.getElementById('motionRightPos').textContent = hwData.hands.right.position;
                        document.getElementById('motionHandMode').textContent = hwData.hands.mode || 'IDLE';
                    }
                }
            } catch (error) {
                // Use console.log instead of addLog to avoid spamming the log if tab is hidden
                console.log(`Failed to update embodied agent data: ${error.message}`);
                // Only add log if it's a critical error or we are in the tab
                if (document.getElementById('embodiedTab').contains(document.activeElement)) {
                    addLog('ERROR', `Data Sync Failed: ${error.message}`);
                }
            }
        }

        async function updateBehaviorHistory() {
            try {
                const response = await fetch('/api/embodied/behavior_history');
                if (response.ok) {
                    const data = await response.json();
                    const behaviorDiv = document.getElementById('behaviorHistory');

                    if (data.length === 0) {
                        behaviorDiv.innerHTML = '<div class="text-gray-500">No behaviors executed yet</div>';
                    } else {
                        behaviorDiv.innerHTML = data.map(entry => {
                            const timestamp = new Date(entry.timestamp).toLocaleTimeString();
                            const alternatives = entry.all_utilities ? entry.all_utilities.map(([name, utility]) =>
                                `${name}: ${utility.toFixed(2)}`
                            ).join(', ') : 'N/A';
                            let colorClass = 'border-indigo-100 bg-indigo-50/50';
                            let textClass = 'text-indigo-700';

                            // Simple heuristic for coloring based on utility
                            if (entry.selected_utility > 0.8) {
                                colorClass = 'border-green-100 bg-green-50/50';
                                textClass = 'text-green-700';
                            }

                            return `<div class="border-b ${colorClass} p-2 mb-1 rounded flex justify-between items-start group hover:bg-white hover:shadow-sm transition-all">
                                <div>
                                    <div class="font-bold ${textClass} text-xs">[${timestamp}] ${entry.selected_behavior}</div>
                                    <div class="text-[10px] text-gray-500 mt-1">Goal: <span class="text-gray-700">${entry.cognitive_state.goal}</span></div>
                                </div>
                                <div class="text-right">
                                    <div class="bg-indigo-100 text-indigo-800 px-1.5 rounded text-[9px] font-bold mb-1">U: ${entry.selected_utility.toFixed(2)}</div>
                                    <div class="text-[9px] text-gray-400 group-hover:text-gray-600">Alt: ${alternatives}</div>
                                </div>
                            </div>`;
                        }).join('');
                    }
                }
            } catch (error) {
                addLog('ERROR', `Failed to update behavior history: ${error.message}`);
            }
        }

        async function updateStateHistory() {
            try {
                const response = await fetch('/api/embodied/state_history');
                if (response.ok) {
                    const data = await response.json();
                    const stateDiv = document.getElementById('stateHistory');

                    if (data.length === 0) {
                        stateDiv.innerHTML = '<div class="p-4 text-center text-gray-300 italic text-xs">No state changes yet</div>';
                    } else {
                        stateDiv.innerHTML = data.map(entry => {
                            const timestamp = new Date(entry.timestamp).toLocaleTimeString();
                            const newState = entry.new_state || {};
                            // Highlights meaningful changes
                            let changes = [];
                            if (newState.posture) changes.push(`Pos: ${newState.posture}`);
                            if (newState.luminance) changes.push(`Lum: ${newState.luminance}`);
                            if (newState.left_hand || newState.right_hand) changes.push(`H: ${newState.left_hand}/${newState.right_hand}`);

                            const changeText = changes.join(', ') || 'Minor update';

                            return `<div class="border-b border-gray-100 p-2 mb-1 rounded flex justify-between items-center bg-white/50 hover:bg-white hover:shadow-sm transition-all">
                                <span class="font-mono text-[10px] text-gray-400">[${timestamp}]</span>
                                <span class="text-xs font-bold text-gray-600">${changeText}</span>
                            </div>`;
                        }).join('');
                    }
                }
            } catch (error) {
                console.log(`Failed to update state history: ${error.message}`);
            }
        }

        // ============================================================================
        // MOOD CONTROL FUNCTIONS
        // ============================================================================

        async function updateMoodFromSlider(moodParam, sliderValue) {
            const moodValue = parseFloat(sliderValue) / 100.0;

            try {
                const response = await fetch('/api/embodied/mood_state', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [moodParam]: moodValue })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.mood_state) {
                        const mood = data.mood_state;

                        // Update all mood displays
                        document.getElementById('moodCuriosityText').textContent = mood.curiosity.toFixed(2);
                        document.getElementById('moodCuriosityBar').style.width = `${mood.curiosity * 100}%`;

                        document.getElementById('moodIrritationText').textContent = mood.irritation.toFixed(2);
                        document.getElementById('moodIrritationBar').style.width = `${mood.irritation * 100}%`;

                        document.getElementById('moodBoredomText').textContent = mood.boredom.toFixed(2);
                        document.getElementById('moodBoredomBar').style.width = `${mood.boredom * 100}%`;

                        document.getElementById('moodAttachmentText').textContent = mood.attachment.toFixed(2);
                        document.getElementById('moodAttachmentBar').style.width = `${mood.attachment * 100}%`;

                        // Update derived states
                        document.getElementById('moodEngagement').textContent = `${Math.round(mood.engagement * 100)}%`;
                        document.getElementById('moodStress').textContent = `${Math.round(mood.stress * 100)}%`;

                        // Update all sliders
                        document.getElementById('moodCuriositySlider').value = Math.round(mood.curiosity * 100);
                        document.getElementById('moodIrritationSlider').value = Math.round(mood.irritation * 100);
                        document.getElementById('moodBoredomSlider').value = Math.round(mood.boredom * 100);
                        document.getElementById('moodAttachmentSlider').value = Math.round(mood.attachment * 100);

                        addLog('MOOD', `${moodParam} updated to ${moodValue.toFixed(2)}`);
                    }
                } else {
                    addLog('ERROR', `Failed to update mood: ${response.statusText}`);
                }
            } catch (error) {
                addLog('ERROR', `Mood update error: ${error.message}`);
            }
        }

        // ============================================================================
        // VISION SYSTEM FUNCTIONS
        // ============================================================================

        let visionEnabled = false;
        let visionFrameInterval = null;

        async function refreshCameras() {
            try {
                const response = await fetch('/api/vision/cameras');
                if (response.ok) {
                    const data = await response.json();
                    const select = document.getElementById('cameraSelect');
                    select.innerHTML = '';

                    if (data.cameras && data.cameras.length > 0) {
                        data.cameras.forEach(cam => {
                            const option = document.createElement('option');
                            option.value = cam.id;
                            option.textContent = `${cam.name} (${cam.resolution})`;
                            if (cam.id === data.current_camera) {
                                option.selected = true;
                            }
                            select.appendChild(option);
                        });
                        addLog('VISION', `Found ${data.cameras.length} camera(s)`);
                    } else {
                        select.innerHTML = '<option value="-1">No cameras detected</option>';
                        addLog('WARNING', 'No cameras detected');
                    }
                }
            } catch (error) {
                console.log('Failed to refresh cameras:', error);
            }
        }

        async function selectCamera(cameraId) {
            try {
                const response = await fetch('/api/vision/select_camera', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ camera_id: parseInt(cameraId) })
                });

                if (response.ok) {
                    addLog('VISION', `Selected camera ${cameraId}`);
                }
            } catch (error) {
                addLog('ERROR', `Camera selection failed: ${error.message}`);
            }
        }

        async function toggleVision() {
            const btn = document.getElementById('visionToggleBtn');
            const text = document.getElementById('visionToggleText');

            try {
                btn.disabled = true;

                if (!visionEnabled) {
                    // First select the camera
                    const cameraId = document.getElementById('cameraSelect').value;
                    if (cameraId === '-1') {
                        addLog('WARNING', 'Please select a camera first');
                        btn.disabled = false;
                        return;
                    }
                    await selectCamera(cameraId);

                    // Start vision
                    text.textContent = 'STARTING...';
                    const response = await fetch('/api/vision/start', { method: 'POST' });
                    const data = await response.json();

                    if (data.success) {
                        visionEnabled = true;
                        text.textContent = 'DEACTIVATE';
                        btn.classList.remove('bg-emerald-600', 'hover:bg-emerald-700');
                        btn.classList.add('bg-red-600', 'hover:bg-red-700');
                        addLog('VISION', 'Vision system activated');

                        // Start frame updates
                        startVisionFrameUpdates();
                    } else {
                        throw new Error(data.error || 'Failed to start vision');
                    }
                } else {
                    // Stop vision
                    text.textContent = 'STOPPING...';
                    await fetch('/api/vision/stop', { method: 'POST' });

                    visionEnabled = false;
                    text.textContent = 'ACTIVATE';
                    btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    btn.classList.add('bg-emerald-600', 'hover:bg-emerald-700');
                    addLog('VISION', 'Vision system deactivated');

                    // Stop frame updates
                    stopVisionFrameUpdates();

                    // Reset UI
                    document.getElementById('visionFrame').classList.add('hidden');
                    document.getElementById('visionPlaceholder').classList.remove('hidden');
                }

            } catch (error) {
                addLog('ERROR', `Vision toggle failed: ${error.message}`);
                text.textContent = visionEnabled ? 'DEACTIVATE' : 'ACTIVATE';
            }

            btn.disabled = false;
        }

        function startVisionFrameUpdates() {
            if (visionFrameInterval) clearInterval(visionFrameInterval);

            // Update frame every 100ms (10 FPS for UI)
            visionFrameInterval = setInterval(async () => {
                if (!visionEnabled || currentTab !== 'vision') return;

                try {
                    const response = await fetch('/api/vision/frame');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.frame) {
                            const img = document.getElementById('visionFrame');
                            img.src = 'data:image/jpeg;base64,' + data.frame;
                            img.classList.remove('hidden');
                            document.getElementById('visionPlaceholder').classList.add('hidden');
                        }
                    }
                } catch (error) {
                    console.log('Frame update error:', error);
                }
            }, 100);
        }

        function stopVisionFrameUpdates() {
            if (visionFrameInterval) {
                clearInterval(visionFrameInterval);
                visionFrameInterval = null;
            }
        }

        async function updateVisionData() {
            try {
                const response = await fetch('/api/vision/status');
                if (response.ok) {
                    const data = await response.json();

                    // Update FPS
                    document.getElementById('visionFps').textContent = `${data.fps.toFixed(1)} FPS`;

                    // Update status indicator
                    const indicator = document.getElementById('visionStatusIndicator').querySelector('div');
                    if (data.enabled && data.camera_active) {
                        indicator.classList.remove('bg-red-500');
                        indicator.classList.add('bg-green-500', 'animate-pulse');
                    } else {
                        indicator.classList.remove('bg-green-500', 'animate-pulse');
                        indicator.classList.add('bg-red-500');
                    }

                    // Update counts
                    document.getElementById('personCount').textContent = data.person_count || 0;
                    document.getElementById('objectCount').textContent = data.object_count || 0;

                    // Update scene description
                    document.getElementById('sceneDescription').textContent = data.scene_description || 'No visual input available.';

                    // Update threat level
                    const threatEl = document.getElementById('visionThreatLevel');
                    const threat = data.threat_assessment || 'none';
                    threatEl.textContent = threat.toUpperCase();

                    // Update threat styling (light mode)
                    threatEl.className = 'px-2 py-0.5 rounded text-xs font-bold uppercase';
                    if (threat === 'high') {
                        threatEl.classList.add('bg-red-100', 'text-red-700', 'border', 'border-red-300');
                    } else if (threat === 'medium') {
                        threatEl.classList.add('bg-yellow-100', 'text-yellow-700', 'border', 'border-yellow-300');
                    } else if (threat === 'low') {
                        threatEl.classList.add('bg-blue-100', 'text-blue-700', 'border', 'border-blue-300');
                    } else {
                        threatEl.classList.add('bg-green-100', 'text-green-700', 'border', 'border-green-300');
                    }

                    // Update system info (light mode)
                    document.getElementById('visionSystemStatus').textContent = data.enabled ? 'ONLINE' : 'OFFLINE';
                    document.getElementById('visionSystemStatus').className = data.enabled ? 'text-green-600 font-bold' : 'text-red-600 font-bold';
                    document.getElementById('visionProcessingTime').textContent = `${data.processing_time_ms.toFixed(1)} ms`;
                    document.getElementById('visionResolution').textContent = `${data.frame_width}x${data.frame_height}`;

                    // Update entity count and list
                    const entities = data.entities || [];
                    document.getElementById('entityCount').textContent = `${entities.length} detected`;

                    const entityList = document.getElementById('entityList');
                    if (entities.length === 0) {
                        entityList.innerHTML = '<div class="text-center text-gray-400 text-xs py-4 italic">No entities detected</div>';
                    } else {
                        entityList.innerHTML = entities.map(entity => {
                            const isPerson = entity.class_name === 'person';
                            const colorClass = isPerson ? 'text-blue-700 border-blue-300' : 'text-orange-700 border-orange-300';
                            const bgClass = isPerson ? 'bg-blue-50' : 'bg-orange-50';

                            return `<div class="flex justify-between items-center p-2 rounded border ${colorClass} ${bgClass}">
                                <div>
                                    <span class="font-bold text-xs uppercase">${entity.class_name}</span>
                                    <span class="text-gray-500 text-[10px] ml-2">${entity.entity_id}</span>
                                </div>
                                <span class="text-xs font-mono">${(entity.confidence * 100).toFixed(0)}%</span>
                            </div>`;
                        }).join('');
                    }

                    // Sync vision state with button
                    visionEnabled = data.enabled;
                    const text = document.getElementById('visionToggleText');
                    const btn = document.getElementById('visionToggleBtn');
                    if (visionEnabled) {
                        text.textContent = 'DEACTIVATE';
                        btn.classList.remove('bg-emerald-600', 'hover:bg-emerald-700');
                        btn.classList.add('bg-red-600', 'hover:bg-red-700');
                    } else {
                        text.textContent = 'ACTIVATE';
                        btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                        btn.classList.add('bg-emerald-600', 'hover:bg-emerald-700');
                    }
                }
            } catch (error) {
                console.log('Vision data update failed:', error);
            }
        }

        // Confidence slider handler
        document.getElementById('confidenceSlider').addEventListener('input', async function () {
            const value = this.value;
            document.getElementById('confidenceValue').textContent = `${value}%`;

            try {
                await fetch('/api/vision/confidence', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ confidence: value / 100 })
                });
            } catch (error) {
                console.log('Confidence update failed:', error);
            }
        });

        // Camera select handler
        document.getElementById('cameraSelect').addEventListener('change', function () {
            if (visionEnabled) {
                addLog('WARNING', 'Stop vision to change camera');
            }
        });

        // ============================================================================
        // PROVIDER SWITCHING
        // ============================================================================

        async function getProviderStatus() {
            try {
                const response = await fetch('/api/settings/provider');
                const data = await response.json();
                updateProviderUI(data.provider, data.model);
            } catch (error) {
                console.error('Failed to get provider status:', error);
            }
        }

        async function setProvider(provider) {
            // Optimistic UI update
            const badge = document.getElementById('providerBadge');
            badge.textContent = 'SWITCHING...';
            badge.className = 'text-[10px] font-bold bg-yellow-500 text-white px-2 py-0.5 rounded uppercase';

            try {
                const response = await fetch('/api/settings/provider', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider: provider })
                });

                const data = await response.json();
                if (data.success) {
                    await getProviderStatus(); // Refresh full status
                } else {
                    alert('Switch failed: ' + data.error);
                    getProviderStatus(); // Revert UI
                }
            } catch (error) {
                console.error('Provider switch error:', error);
                alert('Connection error');
                getProviderStatus();
            }
        }

        function updateProviderUI(provider, model) {
            const btnOllama = document.getElementById('btnOllama');
            const btnGemini = document.getElementById('btnGemini');
            const btnRouter = document.getElementById('btnOpenRouter');
            const badge = document.getElementById('providerBadge');
            const modelDisplay = document.getElementById('currentModelDisplay');

            // Reset all buttons
            [btnOllama, btnGemini, btnRouter].forEach(btn => {
                if (btn) btn.className = 'flex-1 py-1 text-xs font-bold rounded text-center uppercase text-gray-500 hover:text-gray-900';
            });

            if (provider === 'gemini') {
                btnGemini.className = 'flex-1 py-1 text-xs font-bold rounded text-center uppercase bg-white text-blue-600 shadow-sm border border-gray-200';
                badge.textContent = 'CLOUD';
                badge.className = 'text-[10px] font-bold bg-blue-500 text-white px-2 py-0.5 rounded uppercase';
            } else if (provider === 'openrouter') {
                btnRouter.className = 'flex-1 py-1 text-xs font-bold rounded text-center uppercase bg-white text-purple-600 shadow-sm border border-gray-200';
                badge.textContent = 'ROUTER';
                badge.className = 'text-[10px] font-bold bg-purple-500 text-white px-2 py-0.5 rounded uppercase';
            } else {
                btnOllama.className = 'flex-1 py-1 text-xs font-bold rounded text-center uppercase bg-white text-green-600 shadow-sm border border-gray-200';
                badge.textContent = 'LOCAL';
                badge.className = 'text-[10px] font-bold bg-green-500 text-white px-2 py-0.5 rounded uppercase';
            }

            modelDisplay.textContent = `Active Model: ${model}`;
        }

        // ============================================================================
        // LONG TERM MEMORY FUNCTIONS
        // ============================================================================
        async function fetchLongTermMemories() {
            try {
                const response = await fetch('/api/embodied/long_term_memories');
                const memories = await response.json();
                renderLongTermMemories(memories);
            } catch (error) {
                console.error('Failed to fetch memories:', error);
            }
        }

        function renderLongTermMemories(memories) {
            const list = document.getElementById('longTermMemoryList');
            if (!list) return;

            list.innerHTML = '';

            if (memories.length === 0) {
                list.innerHTML = `<div class="p-4 text-center text-gray-400 italic text-xs">No core memories found.</div>`;
                return;
            }

            memories.forEach((mem, index) => {
                const div = document.createElement('div');
                div.className = 'p-3 border-b border-gray-100 hover:bg-gray-50 flex items-start gap-3 group';
                div.innerHTML = `
                    <div class="flex-1">
                        <p class="text-[11px] text-gray-700 leading-relaxed">${mem.content}</p>
                        <p class="text-[9px] text-gray-400 mt-1 font-mono">${new Date(mem.timestamp).toLocaleString()}</p>
                    </div>
                    <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="editMemory(${index}, '${mem.content.replace(/'/g, "\\'")}')" class="p-1 text-blue-400 hover:text-blue-600">
                             <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                        </button>
                        <button onclick="deleteMemory(${index})" class="p-1 text-red-400 hover:text-red-600">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
                list.appendChild(div);
            });

            // Update memory count badge
            const countEl = document.getElementById('memoryCountBadge');
            if (countEl) {
                countEl.textContent = `${memories.length}/10`;
                if (memories.length >= 10) countEl.classList.add('text-red-500');
                else countEl.classList.remove('text-red-500');
            }
        }

        async function addMemoryManual() {
            const content = prompt("Enter new core memory:");
            if (!content) return;

            try {
                const response = await fetch('/api/embodied/long_term_memories/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                if (response.ok) {
                    addLog('MEMORY', `Core memory added manually: ${content}`);
                    fetchLongTermMemories();
                } else {
                    const data = await response.json();
                    alert(data.error);
                }
            } catch (error) {
                addLog('ERROR', 'Failed to add memory');
            }
        }

        async function deleteMemory(index) {
            if (!confirm("Delete this core memory?")) return;

            try {
                const response = await fetch('/api/embodied/long_term_memories/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ index })
                });
                if (response.ok) {
                    addLog('MEMORY', 'Core memory deleted');
                    fetchLongTermMemories();
                }
            } catch (error) {
                addLog('ERROR', 'Failed to delete memory');
            }
        }

        async function editMemory(index, oldContent) {
            const content = prompt("Edit core memory:", oldContent);
            if (!content || content === oldContent) return;

            try {
                const response = await fetch('/api/embodied/long_term_memories/edit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ index, content })
                });
                if (response.ok) {
                    addLog('MEMORY', 'Core memory updated');
                    fetchLongTermMemories();
                }
            } catch (error) {
                addLog('ERROR', 'Failed to edit memory');
            }
        }

        // ============================================================================
        // IMMERSION MODE FUNCTIONS
        // ============================================================================

        let immersionModeActive = false;
        let soundVisualizerCanvas = null;
        let soundVisualizerCtx = null;
        let visualizerAnimationId = null;
        let isAISpeaking = false;
        let visualizerBars = [];
        const VISUALIZER_BAR_COUNT = 64;

        // Initialize visualizer bars
        for (let i = 0; i < VISUALIZER_BAR_COUNT; i++) {
            visualizerBars.push(0);
        }

        function toggleImmersionMode() {
            immersionModeActive = !immersionModeActive;
            const overlay = document.getElementById('immersionMode');

            if (immersionModeActive) {
                overlay.classList.remove('hidden');
                initSoundVisualizer();
                syncImmersionChat();

                // Focus on immersion input
                document.getElementById('immersionChatInput').focus();
            } else {
                overlay.classList.add('hidden');
                stopSoundVisualizer();
            }
        }

        function initSoundVisualizer() {
            soundVisualizerCanvas = document.getElementById('soundVisualizer');
            soundVisualizerCtx = soundVisualizerCanvas.getContext('2d');

            // Set canvas size
            const container = soundVisualizerCanvas.parentElement;
            soundVisualizerCanvas.width = container.clientWidth;
            soundVisualizerCanvas.height = container.clientHeight;

            // Start animation
            animateSoundVisualizer();
        }

        function animateSoundVisualizer() {
            if (!immersionModeActive || !soundVisualizerCtx) return;

            const canvas = soundVisualizerCanvas;
            const ctx = soundVisualizerCtx;
            const width = canvas.width;
            const height = canvas.height;
            const centerY = height / 2;
            const time = Date.now();

            // Clear canvas with full black
            ctx.fillStyle = 'rgba(0, 0, 0, 1)';
            ctx.fillRect(0, 0, width, height);

            // Draw center line
            ctx.strokeStyle = 'rgba(52, 211, 153, 0.15)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, centerY);
            ctx.lineTo(width, centerY);
            ctx.stroke();

            if (isAISpeaking && audioAnalyser && audioDataArray) {
                // REAL-TIME AUDIO VISUALIZATION using Web Audio API
                // Get frequency data from the actual audio being played
                audioAnalyser.getByteFrequencyData(audioDataArray);

                // Draw frequency bars (mirrored from center)
                ctx.fillStyle = '#10b981';
                ctx.shadowBlur = 15;
                ctx.shadowColor = '#10b981';

                const barWidth = width / audioBufferLength;
                let x = 0;

                for (let i = 0; i < audioBufferLength; i++) {
                    const barHeight = (audioDataArray[i] / 255) * (height * 0.4);
                    ctx.fillRect(x, centerY - barHeight, barWidth - 1, barHeight);
                    ctx.fillRect(x, centerY, barWidth - 1, barHeight);
                    x += barWidth;
                }

                ctx.shadowBlur = 0;

                // Also draw waveform overlay
                audioAnalyser.getByteTimeDomainData(audioDataArray);

                ctx.strokeStyle = '#34d399';
                ctx.lineWidth = 2;
                ctx.shadowBlur = 10;
                ctx.shadowColor = '#34d399';
                ctx.beginPath();

                const sliceWidth = width / audioBufferLength;
                x = 0;

                for (let i = 0; i < audioBufferLength; i++) {
                    const v = audioDataArray[i] / 128.0; // Normalize to 0-2 range
                    const y = centerY + ((v - 1.0) * height * 0.4); // Center around centerY, scale to 40% of height

                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }

                    x += sliceWidth;
                }

                ctx.stroke();
                ctx.shadowBlur = 0;

            } else {
                // Idle: flat line with minimal pulse
                ctx.strokeStyle = '#059669';
                ctx.lineWidth = 2.5;
                ctx.shadowBlur = 8;
                ctx.shadowColor = '#059669';

                ctx.beginPath();
                const pulse = Math.sin(time * 0.0015) * 1;

                for (let x = 0; x < width; x++) {
                    const noise = (Math.random() - 0.5) * 0.3;
                    const y = centerY + pulse + noise;

                    if (x === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }

                ctx.stroke();
                ctx.shadowBlur = 0;
            }

            // Continue animation
            visualizerAnimationId = requestAnimationFrame(animateSoundVisualizer);
        }

        function stopSoundVisualizer() {
            if (visualizerAnimationId) {
                cancelAnimationFrame(visualizerAnimationId);
                visualizerAnimationId = null;
            }
        }

        function syncImmersionChat() {
            const immersionHistory = document.getElementById('immersionChatHistory');
            const mainHistory = document.getElementById('chatHistory');

            // Copy chat history to immersion mode
            // Only select direct children to avoid nested divs
            const messages = Array.from(mainHistory.children);
            immersionHistory.innerHTML = '';

            messages.forEach(msg => {
                // Create a new div instead of cloning to avoid nested structure issues
                const div = document.createElement('div');
                div.classList.add('immersion-chat-message');

                const textContent = msg.textContent;

                // Add appropriate class and copy content based on sender
                if (textContent.includes('OPERATOR:')) {
                    div.classList.add('user');
                    div.innerHTML = msg.innerHTML;
                } else if (textContent.includes('ASR-7:')) {
                    div.classList.add('ai');
                    div.innerHTML = msg.innerHTML;
                } else {
                    // System or other messages
                    div.innerHTML = msg.innerHTML;
                }

                immersionHistory.appendChild(div);
            });

            // Scroll to bottom
            immersionHistory.scrollTop = immersionHistory.scrollHeight;
        }

        function addImmersionMessage(sender, message) {
            if (!immersionModeActive) return;

            const immersionHistory = document.getElementById('immersionChatHistory');
            const timeStr = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.classList.add('immersion-chat-message');

            if (sender === 'USER') {
                div.classList.add('user');
                div.innerHTML = `<span style="opacity: 0.6">[${timeStr}]</span> <span style="font-weight: bold">OPERATOR:</span> ${message}`;
            } else if (sender === 'ASSAULTRON') {
                div.classList.add('ai');
                div.innerHTML = `<span style="opacity: 0.6">[${timeStr}]</span> <span style="font-weight: bold">ASR-7:</span> ${message}`;
            }

            immersionHistory.appendChild(div);
            immersionHistory.scrollTop = immersionHistory.scrollHeight;
        }

        async function sendImmersionMessage() {
            const input = document.getElementById('immersionChatInput');
            const sendBtn = document.getElementById('immersionSendBtn');
            const message = input.value.trim();

            if (!message) return;

            // Save reference to image file before clearing
            let imagePath = null;
            let imageFile = null;
            if (immersionImageInput.files.length > 0) {
                imageFile = immersionImageInput.files[0];
            }

            input.value = '';
            sendBtn.disabled = true;
            sendBtn.textContent = 'TRANSMITTING';

            // Mark user as active
            markUserActive();

            // START VISUALIZER IMMEDIATELY when request is sent
            isAISpeaking = true;

            try {
                // Handle image upload if present
                if (imageFile) {
                    const formData = new FormData();
                    formData.append('image', imageFile);

                    const uploadResponse = await fetch('/api/chat/upload_image', {
                        method: 'POST',
                        body: formData
                    });

                    if (uploadResponse.ok) {
                        const uploadData = await uploadResponse.json();
                        imagePath = uploadData.image_path;
                    } else {
                        throw new Error('Image upload failed');
                    }

                    // Clear the image
                    clearImmersionImage();
                }

                // Add to immersion chat (after upload so we have imagePath)
                addImmersionMessage('USER', message);

                // Also add to main chat with image
                addChatMessage('USER', message, null, imagePath);

                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        image_path: imagePath
                    })
                });

                if (response.ok) {
                    const data = await response.json();

                    // Add response to both chats
                    addImmersionMessage('ASSAULTRON', data.response);
                    addChatMessage('ASSAULTRON', data.response);

                    // Keep visualizer active for duration based on response
                    // If voice is enabled, the polling will keep it synced
                    // If not, we simulate based on response length
                    if (!data.voice_enabled) {
                        const speakDuration = Math.min(data.response.length * 50, 10000);
                        setTimeout(() => {
                            isAISpeaking = false;
                        }, speakDuration);
                    }

                    // Update embodied agent display if on that tab
                    if (currentTab === 'embodied') {
                        updateEmbodiedAgentData();
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                addImmersionMessage('SYSTEM', `Error: ${error.message}`);
                addChatMessage('SYSTEM', `Error: ${error.message}`);
                isAISpeaking = false;
            }

            sendBtn.disabled = false;
            sendBtn.textContent = 'TRANSMIT';
        }

        // Event listeners for immersion mode
        document.addEventListener('DOMContentLoaded', () => {
            const immersionInput = document.getElementById('immersionChatInput');
            const immersionSendBtn = document.getElementById('immersionSendBtn');

            if (immersionInput) {
                immersionInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') sendImmersionMessage();
                });
            }

            if (immersionSendBtn) {
                immersionSendBtn.addEventListener('click', sendImmersionMessage);
            }

            // Handle window resize for visualizer
            window.addEventListener('resize', () => {
                if (immersionModeActive && soundVisualizerCanvas) {
                    const container = soundVisualizerCanvas.parentElement;
                    soundVisualizerCanvas.width = container.clientWidth;
                    soundVisualizerCanvas.height = container.clientHeight;
                }
            });
        });

        // Initialize state
        startTime = Date.now();
        updateStats();
        updateUptime();
        setInterval(updateStats, 5000);
        setInterval(updateUptime, 1000);

        // Load history on startup
        loadHistory();

        // ============================================================================
        // NOTIFICATION SYSTEM FUNCTIONS
        // ============================================================================

        let inactivityMonitoringEnabled = true;
        let backgroundMonitoringEnabled = false;

        async function toggleInactivityMonitoring() {
            try {
                inactivityMonitoringEnabled = !inactivityMonitoringEnabled;
                const response = await fetch('/api/notifications/inactivity/toggle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enable: inactivityMonitoringEnabled })
                });

                const data = await response.json();
                if (data.success) {
                    updateNotificationUI();
                    addLog('INFO', data.message);
                }
            } catch (error) {
                addLog('ERROR', `Failed to toggle inactivity monitoring: ${error.message}`);
            }
        }

        async function toggleBackgroundMonitoring() {
            try {
                backgroundMonitoringEnabled = !backgroundMonitoringEnabled;
                const response = await fetch('/api/notifications/background/toggle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        enable: backgroundMonitoringEnabled,
                        check_interval: 30
                    })
                });

                const data = await response.json();
                if (data.success) {
                    updateNotificationUI();
                    addLog('INFO', data.message);
                }
            } catch (error) {
                addLog('ERROR', `Failed to toggle background monitoring: ${error.message}`);
            }
        }

        async function updateNotificationConfig() {
            try {
                const minInterval = parseInt(document.getElementById('minInterval').value);
                const inactivityThresholdMin = parseInt(document.getElementById('inactivityThresholdMin').value);
                const inactivityThresholdMax = parseInt(document.getElementById('inactivityThresholdMax').value);

                const response = await fetch('/api/notifications/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        min_interval: minInterval,
                        inactivity_threshold_min: inactivityThresholdMin,
                        inactivity_threshold_max: inactivityThresholdMax
                    })
                });

                const data = await response.json();
                if (data.success) {
                    addLog('SUCCESS', `AI check-ins now every ${inactivityThresholdMin/60}-${inactivityThresholdMax/60} min`);
                }
            } catch (error) {
                addLog('ERROR', `Failed to update config: ${error.message}`);
            }
        }

        async function testNotification() {
            try {
                const response = await fetch('/api/notifications/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: 'Assaultron AI - Test',
                        message: 'Windows notification system is working!'
                    })
                });

                const data = await response.json();
                if (data.success) {
                    addLog('SUCCESS', 'Test notification sent - check your desktop!');
                } else {
                    addLog('WARNING', 'Failed to send notification');
                }
            } catch (error) {
                addLog('ERROR', `Notification test failed: ${error.message}`);
            }
        }

        function updateNotificationUI() {
            // Update status display
            const inactivityStatusEl = document.getElementById('inactivityStatus');
            const backgroundStatusEl = document.getElementById('backgroundStatus');
            const inactivityBtnEl = document.getElementById('toggleInactivity');
            const backgroundBtnEl = document.getElementById('toggleBackground');

            if (inactivityMonitoringEnabled) {
                inactivityStatusEl.textContent = 'ACTIVE';
                inactivityStatusEl.className = 'font-bold text-green-600';
                inactivityBtnEl.textContent = 'ENABLED';
                inactivityBtnEl.className = 'px-3 py-1 bg-green-600 text-white rounded text-[10px] font-bold hover:bg-green-700 transition-colors';
            } else {
                inactivityStatusEl.textContent = 'INACTIVE';
                inactivityStatusEl.className = 'font-bold text-gray-400';
                inactivityBtnEl.textContent = 'DISABLED';
                inactivityBtnEl.className = 'px-3 py-1 bg-gray-400 text-white rounded text-[10px] font-bold hover:bg-gray-500 transition-colors';
            }

            if (backgroundMonitoringEnabled) {
                backgroundStatusEl.textContent = 'ACTIVE';
                backgroundStatusEl.className = 'font-bold text-green-600';
                backgroundBtnEl.textContent = 'ENABLED';
                backgroundBtnEl.className = 'px-3 py-1 bg-green-600 text-white rounded text-[10px] font-bold hover:bg-green-700 transition-colors';
            } else {
                backgroundStatusEl.textContent = 'INACTIVE';
                backgroundStatusEl.className = 'font-bold text-gray-400';
                backgroundBtnEl.textContent = 'DISABLED';
                backgroundBtnEl.className = 'px-3 py-1 bg-gray-400 text-white rounded text-[10px] font-bold hover:bg-gray-500 transition-colors';
            }
        }

        async function loadNotificationConfig() {
            try {
                const response = await fetch('/api/notifications/config');
                if (response.ok) {
                    const config = await response.json();
                    document.getElementById('minInterval').value = config.min_interval;
                    document.getElementById('inactivityThresholdMin').value = config.inactivity_threshold_min || 300;
                    document.getElementById('inactivityThresholdMax').value = config.inactivity_threshold_max || 1800;
                    inactivityMonitoringEnabled = config.inactivity_monitoring;
                    updateNotificationUI();
                }
            } catch (error) {
                console.log('Failed to load notification config:', error.message);
            }
        }

        // Load notification config on startup
        loadNotificationConfig();

        // Check voice playback status for immersion mode visualizer
        // Voice playback status is now tracked via audio player event listeners
        // in playVoiceAudio() function - no need to poll backend

        // Additional periodic updates (kept from original)
        setInterval(() => {
            if (currentTab === 'embodied') {
                updateEmbodiedAgentData();
                loadNotificationConfig(); // Refresh notification status
            }
            if (currentTab === 'vision' && visionEnabled) {
                updateVisionData();
            }

            // Check for new audio
            updateVoiceSystemStatus();
        }, 2000); // Update tab-specific data every 2 seconds (reduced from 500ms to prevent lag)
    </script>
</body>

</html>